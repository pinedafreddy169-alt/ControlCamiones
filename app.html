<script>
// ======== CONFIG =========
const GAS_ENDPOINT = "https://script.google.com/macros/s/AKfycbzwggbJrozcTXMq9aEoW5vSh69AlgfpoCYfCYWvCOYdDF7jMEnF8w2j39qFyYYC6VlO/exec"; // <-- TU URL /exec

// ======== FUNCIONES ========

// Arma un registro con los valores del formulario
function buildRecordFromForm() {
  return {
    fecha:          document.querySelector("#fecha")?.value || "",
    camion:         document.querySelector("#camion")?.value || "",
    placa:          document.querySelector("#placa")?.value || "",
    chofer:         document.querySelector("#chofer")?.value || "",
    origenFinca:    document.querySelector("#origenFinca")?.value || "",
    origenLote:     document.querySelector("#origenLote")?.value || "",
    destinoFinca:   document.querySelector("#destinoFinca")?.value || "",
    destinoLote:    document.querySelector("#destinoLote")?.value || "",
    salida:         document.querySelector("#horaSalida")?.value || "",
    llegada:        document.querySelector("#horaLlegada")?.value || "",
    observaciones:  document.querySelector("#observaciones")?.value || ""
  };
}

// Guarda en localStorage (por si no hay internet)
function saveLocalRecord(record) {
  const key = "ccamiones_local";
  const current = JSON.parse(localStorage.getItem(key) || "[]");
  current.push(record);
  localStorage.setItem(key, JSON.stringify(current));
  updateLocalCountUI(current.length);
}

function getLocalRecords() {
  return JSON.parse(localStorage.getItem("ccamiones_local") || "[]");
}

function clearLocalRecords() {
  localStorage.setItem("ccamiones_local", "[]");
  updateLocalCountUI(0);
}

function updateLocalCountUI(n) {
  const el = document.querySelector("#registrosLocales");
  if (el) el.textContent = n;
}

// POST hacia Google Apps Script
async function postToGas(record) {
  const res = await fetch(GAS_ENDPOINT, {
    method: "POST",
    headers: { "Content-Type": "text/plain;charset=utf-8" }, // evita CORS preflight
    body: JSON.stringify(record)
  });

  const text = await res.text();
  let json;
  try { json = JSON.parse(text); } catch(_) { throw new Error("Respuesta no JSON: " + text); }

  if (!res.ok || json.status !== "ok") {
    throw new Error(json.message || "Error en sincronización");
  }
  return json;
}

// Sincroniza todos los registros locales
async function syncAll() {
  const records = getLocalRecords();
  if (!records.length) {
    alert("No hay registros locales para sincronizar.");
    return;
  }

  try {
    for (let r of records) {
      await postToGas(r);
    }
    clearLocalRecords();
    alert("¡Sincronización exitosa!");
  } catch (err) {
    console.error(err);
    alert("Falló la sincronización: " + err.message);
  }
}

// Botón GUARDAR (local)
function onGuardarClick() {
  const rec = buildRecordFromForm();
  if (!rec.fecha || !rec.camion || !rec.chofer) {
    alert("Fecha, Camión y Chofer son obligatorios.");
    return;
  }
  saveLocalRecord(rec);
  alert("Guardado localmente.");
}

// Botón SINCRONIZAR
function onSincronizarClick() {
  syncAll();
}

// Inicializar contador al cargar
document.addEventListener("DOMContentLoaded", () => {
  updateLocalCountUI(getLocalRecords().length);
});
</script>
