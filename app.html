<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Control de Camiones</title>
  <style>
    :root{
      --bg:#0b1220;--card:#121a2b;--muted:#9ba8bf;--line:#23314f;--text:#e8eefc;
      --ok:#27c380;--warn:#ff7b7b;--primary:#3fa0ff
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:1000px;margin:0 auto;padding:16px 12px}
    header{display:flex;justify-content:space-between;align-items:center;gap:12px}
    h1{margin:10px 0 16px}
    .user{color:#9ba8bf;font-size:14px;display:flex;gap:8px;align-items:center}
    .logout{background:#c84545;color:#fff;border:0;border-radius:10px;padding:8px 12px;cursor:pointer}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;position:sticky;top:0;background:var(--bg);padding:8px 0;z-index:5}
    .tabbtn{border:1px solid var(--line);background:var(--card);color:var(--text);padding:10px 14px;border-radius:12px;cursor:pointer}
    .tabbtn.active{outline:2px solid var(--primary)}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px;margin-top:12px}
    label{display:block;margin-top:10px;font-size:14px;color:var(--muted)}
    input,select,textarea{width:100%;padding:10px;margin-top:6px;border:1px solid var(--line);border-radius:10px;background:#0f1526;color:var(--text)}
    .row{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px}
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px;align-items:center}
    button{border:0;border-radius:12px;padding:12px 14px;cursor:pointer;font-weight:600}
    .save{background:var(--ok);color:#0b281c}
    .ghost{background:#32415f;color:#dfe7ff}
    .sync{background:var(--primary);color:#04101f}
    .pdf{background:#23314f;color:#e8eefc}
    .mini{padding:8px 10px;border-radius:10px}
    #estado{font-size:14px}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:10px;border-bottom:1px solid var(--line);text-align:left}
    th{color:var(--muted)}
    .right{display:flex;gap:8px;justify-content:flex-end}
    .danger{background:#c84545;color:#fff}
    .success{color:var(--ok)} .error{color:var(--warn)}
    .chip{background:#23314f;color:#e8eefc;padding:4px 8px;border-radius:10px;margin:3px;display:inline-flex;gap:6px;align-items:center}

    /* Seguridad admin Fincas & Lotes */
    .adminLock{background:#0f1526;border:1px dashed #3b4b6b;border-radius:12px;padding:12px;margin-top:8px}
    .adminLock input{width:auto;min-width:140px;display:inline-block;margin-right:8px}
    .badge-lock{display:inline-block;background:#32415f;color:#e8eefc;padding:4px 8px;border-radius:8px;margin-left:8px;font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>üöõ Control de Camiones</h1>
      <div class="user">
        Usuario: <span id="who"></span>
        <button class="logout" id="btnLogout">Cerrar sesi√≥n</button>
      </div>
    </header>

    <!-- NAV PESTA√ëAS -->
    <div class="tabs">
      <button class="tabbtn active" data-tab="viajes">Viajes</button>
      <button class="tabbtn" data-tab="camiones">Camiones</button>
      <button class="tabbtn" data-tab="choferes">Choferes</button>
      <button class="tabbtn" data-tab="fincas">Fincas & Lotes</button>
    </div>

    <!-- ====== TAB: VIAJES ====== -->
    <section id="tab-viajes" class="card">
      <div class="row">
        <div>
          <label>Fecha</label>
          <input id="fecha" type="date"/>
        </div>
        <div>
          <label>Cami√≥n</label>
          <select id="camionSel"></select>
        </div>
        <div>
          <label>Placa</label>
          <input id="placa" readonly placeholder="Se llena al elegir cami√≥n"/>
        </div>
        <div>
          <label>Chofer</label>
          <select id="choferSel"></select>
        </div>

        <!-- ORIGEN -->
        <div>
          <label>Origen - Finca</label>
          <input id="origenFinca" placeholder="Escribe o elige‚Ä¶" list="dlFincas" autocomplete="off"/>
        </div>
        <div>
          <label>Origen - Lote</label>
          <input id="origenLote" placeholder="Escribe o elige‚Ä¶" list="dlLotesOrigen" autocomplete="off"/>
        </div>

        <!-- DESTINO -->
        <div>
          <label>Destino - Finca</label>
          <input id="destinoFinca" placeholder="Escribe o elige‚Ä¶" list="dlFincas" autocomplete="off"/>
        </div>
        <div>
          <label>Destino - Lote</label>
          <input id="destinoLote" placeholder="Escribe o elige‚Ä¶" list="dlLotesDestino" autocomplete="off"/>
        </div>

        <!-- DATALISTS -->
        <datalist id="dlFincas"></datalist>
        <datalist id="dlLotesOrigen"></datalist>
        <datalist id="dlLotesDestino"></datalist>

        <div>
          <label>Salida</label>
          <input id="salida" type="time"/>
        </div>
        <div>
          <label>Llegada</label>
          <input id="llegada" type="time"/>
        </div>
      </div>

      <label style="margin-top:12px;">Observaciones</label>
      <textarea id="obs" rows="2" placeholder="Notas‚Ä¶"></textarea>

      <div class="btns">
        <button class="save" id="btnGuardar">Guardar (cola local)</button>
        <button class="ghost" id="btnLimpiar">Limpiar</button>
        <span id="estado"></span>
        <div class="right">
          <button class="sync" id="btnSync">Sincronizar</button>
          <button class="pdf" id="btnPDF">Descargar PDF</button>
        </div>
      </div>

      <div class="card" style="margin-top:16px">
        <h3>üìã √öltimos registros (local)</h3>
        <table>
          <thead>
            <tr>
              <th>Fecha</th><th>Cami√≥n</th><th>Placa</th><th>Chofer</th>
              <th>Origen</th><th>Destino</th><th>Salida</th><th>Llegada</th><th>Obs</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </section>

    <!-- ====== TAB: CAMIONES ====== -->
    <section id="tab-camiones" class="card" style="display:none">
      <h3>üöö Camiones</h3>
      <div class="row">
        <div>
          <label>Nombre del cami√≥n</label>
          <input id="newCamion" placeholder="Cami√≥n 01"/>
        </div>
        <div>
          <label>Placa</label>
          <input id="newPlaca" placeholder="ABC-123"/>
        </div>
      </div>
      <div class="btns">
        <button class="save mini" id="btnAddCamion">+ Agregar cami√≥n</button>
        <button class="danger mini" id="btnClearCamiones">Borrar todos</button>
      </div>

      <div class="card" style="margin-top:12px">
        <table>
          <thead><tr><th>Cami√≥n</th><th>Placa</th><th></th></tr></thead>
          <tbody id="tbodyCamiones"></tbody>
        </table>
      </div>
    </section>

    <!-- ====== TAB: CHOFERES ====== -->
    <section id="tab-choferes" class="card" style="display:none">
      <h3>üßë‚Äç‚úàÔ∏è Choferes</h3>
      <div class="row">
        <div>
          <label>Nombre del chofer</label>
          <input id="newChofer" placeholder="Braulio"/>
        </div>
      </div>
      <div class="btns">
        <button class="save mini" id="btnAddChofer">+ Agregar chofer</button>
        <button class="danger mini" id="btnClearChoferes">Borrar todos</button>
      </div>

      <div class="card" style="margin-top:12px">
        <table>
          <thead><tr><th>Chofer</th><th></th></tr></thead>
          <tbody id="tbodyChoferes"></tbody>
        </table>
      </div>
    </section>

    <!-- ====== TAB: FINCAS & LOTES ====== -->
    <section id="tab-fincas" class="card" style="display:none">
      <h3>üè∑Ô∏è Fincas & Lotes</h3>

      <!-- Barra de seguridad -->
      <div class="adminLock" id="adminBar">
        <strong>Edici√≥n protegida</strong>
        <span id="lockState" class="badge-lock">Bloqueado</span>
        <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;align-items:center">
          <input id="adminUser" placeholder="Usuario" autocomplete="off"/>
          <input id="adminPass" type="password" placeholder="Clave" autocomplete="off"/>
          <button class="save mini" id="btnUnlock">Desbloquear edici√≥n</button>
          <button class="danger mini" id="btnLock" style="display:none">Bloquear</button>
        </div>
        <div id="adminMsg" style="margin-top:6px;color:#ff7b7b;font-size:14px"></div>
      </div>

      <div class="row">
        <div>
          <label>Nueva finca</label>
          <input id="newFinca" placeholder="Cuyo, Buenavista‚Ä¶"/>
        </div>
      </div>
      <div class="btns">
        <button class="save mini" id="btnAddFinca">+ Agregar finca</button>
        <button class="danger mini" id="btnClearFincas">Borrar todas</button>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="row">
          <div>
            <label>Finca (para agregar lote)</label>
            <select id="fincaParaLote"></select>
          </div>
          <div>
            <label>Nuevo lote</label>
            <input id="newLote" placeholder="Lote 1, Lote 2‚Ä¶"/>
          </div>
        </div>
        <div class="btns">
          <button class="save mini" id="btnAddLote">+ Agregar lote a finca</button>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <table>
          <thead><tr><th>Finca</th><th>Lotes</th><th></th></tr></thead>
          <tbody id="tbodyFincas"></tbody>
        </table>
      </div>

      <!-- Importar / Exportar CSV -->
      <div class="card" style="margin-top:12px">
        <h4>üì• Importar / üì§ Exportar cat√°logo</h4>
        <div class="row">
          <div>
            <label>Archivo CSV (finca,lote)</label>
            <input type="file" id="csvFincas" accept=".csv"/>
          </div>
        </div>

        <div class="row" style="margin-top:8px">
          <div>
            <label>Pegar CSV (finca,lote)</label>
            <textarea id="csvText" rows="6" placeholder="finca,lote
Cuyo,Lote 1
Cuyo,Lote 2
Buenavista,Lote 1" style="width:100%;padding:10px;border:1px solid #23314f;border-radius:10px;background:#0f1526;color:#e8eefc"></textarea>
          </div>
        </div>

        <div class="btns">
          <button class="save mini" id="btnImportCSV">Importar CSV</button>
          <button class="save mini" id="btnImportText">Importar desde texto</button>
          <button class="ghost mini" id="btnExportCSV">Exportar CSV</button>
          <button class="ghost mini" id="btnPlantillaCSV">Descargar plantilla</button>
        </div>
        <p class="msg" style="margin-top:8px">
          Formato: <code>finca,lote</code> (con o sin encabezado). Acepta coma o punto y coma.
        </p>
      </div>
    </section>
  </div>

  <script>
    /* === CHECK DE SESI√ìN === */
    const who = localStorage.getItem('session_user');
    if(!who) { try { location.href = 'index.html'; } catch(_){} }
    document.getElementById('who').textContent = who || 'Invitado';
    document.getElementById('btnLogout').addEventListener('click', ()=>{
      localStorage.removeItem('session_user'); location.href = 'index.html';
    });

    /* === CONFIG === */
    const ENDPOINT = "https://script.google.com/macros/s/AKfycbzwggbJrozcTXMq9aEoW5vSh69AlgfpoCYfCYWvCOYdDF7jMEnF8w2j39qFyYYC6VlO/exec";

    /* === KEYS/ESTADO === */
    const QKEY   = 'cc_queue_v1';
    const CAMKEY = 'cc_camiones_v1';
    const CHOKEY = 'cc_choferes_v1';
    const FKEY   = 'cc_fincas_v1';

    let camiones = [];
    let choferes = [];
    let fincas   = [];

    /* === Seguridad Admin (solo modifica Fincas & Lotes) === */
    const ADMIN_USER = 'AMID';
    const ADMIN_PASS = 'BYC2024';
    const ADMIN_KEY  = 'cc_admin_ok_v1'; // se guarda por navegador
    let isAdmin = false;

    // Refs admin
    const lockState = document.getElementById('lockState');
    const adminMsg  = document.getElementById('adminMsg');
    const adminUser = document.getElementById('adminUser');
    const adminPass = document.getElementById('adminPass');
    const btnUnlock = document.getElementById('btnUnlock');
    const btnLock   = document.getElementById('btnLock');

    function toggleFincasEditable(enabled){
      const scope = document.getElementById('tab-fincas');
      scope.querySelectorAll('input, select, textarea').forEach(el=>{
        if(el.id==='adminUser' || el.id==='adminPass') return;
        el.disabled = !enabled;
      });
      scope.querySelectorAll('button').forEach(b=>{
        if(b.id==='btnUnlock' || b.id==='btnLock') return;
        b.disabled = !enabled;
      });
    }
    function setAdminUI(){
      if(isAdmin){
        lockState.textContent = 'Desbloqueado';
        lockState.style.background = '#27c380'; lockState.style.color = '#042b1c';
        btnUnlock.style.display='none';
        btnLock.style.display='inline-block';
        adminMsg.textContent='';
        toggleFincasEditable(true);
      }else{
        lockState.textContent = 'Bloqueado';
        lockState.style.background = '#32415f'; lockState.style.color = '#e8eefc';
        btnUnlock.style.display='inline-block';
        btnLock.style.display='none';
        adminMsg.textContent='';
        toggleFincasEditable(false);
      }
    }
    function loadAdminState(){
      isAdmin = localStorage.getItem(ADMIN_KEY) === 'true';
      setAdminUI();
    }
    btnUnlock.addEventListener('click', ()=>{
      const u = (adminUser.value||'').trim();
      const p = (adminPass.value||'').trim();
      // (Opcional) bloquear intento desde m√≥vil:
      // if (/Mobi|Android/i.test(navigator.userAgent)) { adminMsg.textContent = 'El desbloqueo solo se permite en la computadora.'; return; }
      if(u===ADMIN_USER && p===ADMIN_PASS){
        isAdmin = true; localStorage.setItem(ADMIN_KEY, 'true'); setAdminUI();
      }else{
        adminMsg.textContent='Usuario o clave incorrectos';
      }
    });
    btnLock.addEventListener('click', ()=>{
      isAdmin = false; localStorage.removeItem(ADMIN_KEY); setAdminUI();
    });

    /* === UI refs === */
    const estado  = document.getElementById('estado');
    const tbody   = document.getElementById('tbody');
    const tCam    = document.getElementById('tbodyCamiones');
    const tChof   = document.getElementById('tbodyChoferes');
    const tFin    = document.getElementById('tbodyFincas');

    // Viajes
    const origenFinca   = document.getElementById('origenFinca');
    const origenLote    = document.getElementById('origenLote');
    const destinoFinca  = document.getElementById('destinoFinca');
    const destinoLote   = document.getElementById('destinoLote');

    // Datalists
    const dlFincas        = document.getElementById('dlFincas');
    const dlLotesOrigen   = document.getElementById('dlLotesOrigen');
    const dlLotesDestino  = document.getElementById('dlLotesDestino');

    // Fincas tab
    const fincaParaLote = document.getElementById('fincaParaLote');

    /* === Tabs === */
    document.querySelectorAll('.tabbtn').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        document.querySelectorAll('.tabbtn').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        const tab = btn.dataset.tab;
        document.querySelectorAll('section[id^="tab-"]').forEach(s=>s.style.display='none');
        document.getElementById('tab-'+tab).style.display='block';
      });
    });

    /* === Helpers === */
    function setEstado(msg, ok=true){ estado.textContent = msg; estado.className = ok ? 'success' : 'error'; }
    function hoyISO(){ return new Date().toISOString().slice(0,10); }

    /* === Storage Listas === */
    function loadLists(){
      camiones = JSON.parse(localStorage.getItem(CAMKEY) || '[]');
      choferes = JSON.parse(localStorage.getItem(CHOKEY) || '[]');
      fincas   = JSON.parse(localStorage.getItem(FKEY)   || '[]');

      if(!camiones.length) camiones = [{nombre:'Cami√≥n 01', placa:'ABC-123'}];
      if(!choferes.length) choferes = ['Braulio'];
      if(!fincas.length) fincas = [
        { nombre: 'Cuyo',       lotes: ['Lote 1','Lote 2','Lote 3','Lote 4'] },
        { nombre: 'Buenavista', lotes: ['Lote 1','Lote 2','Lote 3','Lote 4'] }
      ];

      saveLists();
    }
    function saveLists(){
      localStorage.setItem(CAMKEY, JSON.stringify(camiones));
      localStorage.setItem(CHOKEY, JSON.stringify(choferes));
      localStorage.setItem(FKEY,   JSON.stringify(fincas));
    }

    /* === Renders === */
    function renderCamionesTable(){
      tCam.innerHTML = '';
      camiones.forEach((c,i)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${c.nombre}</td><td>${c.placa}</td>
          <td class="right"><button class="danger mini" data-i="${i}">Borrar</button></td>`;
        tCam.appendChild(tr);
      });
      tCam.querySelectorAll('button[data-i]').forEach(b=>{
        b.addEventListener('click', ()=>{
          camiones.splice(+b.dataset.i,1); saveLists(); renderCamionesTable(); populateSelects(); actualizarPlaca();
        });
      });
    }
    function renderChoferesTable(){
      tChof.innerHTML = '';
      choferes.forEach((c,i)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${c}</td>
          <td class="right"><button class="danger mini" data-i="${i}">Borrar</button></td>`;
        tChof.appendChild(tr);
      });
      tChof.querySelectorAll('button[data-i]').forEach(b=>{
        b.addEventListener('click', ()=>{
          choferes.splice(+b.dataset.i,1); saveLists(); renderChoferesTable(); populateSelects();
        });
      });
    }

    // Tabla de fincas + lotes (con borrar lote puntual)
    function renderFincasTable(){
      tFin.innerHTML = '';
      fincas.forEach((f,idx)=>{
        const lotesHtml = f.lotes.map((l, li) => `
          <span class="chip">
            ${l}
            <button title="Borrar lote" class="danger mini" data-f="${idx}" data-l="${li}" style="padding:2px 6px">‚úï</button>
          </span>`).join(' ');
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${f.nombre}</td>
          <td>${lotesHtml}</td>
          <td class="right"><button class="danger mini" data-i="${idx}">Borrar finca</button></td>`;
        tFin.appendChild(tr);
      });

      // Borrar finca (requiere admin)
      tFin.querySelectorAll('button[data-i]').forEach(b=>{
        b.addEventListener('click', ()=>{
          if(!isAdmin){ alert('Solo el administrador puede modificar Fincas & Lotes'); return; }
          const i = +b.dataset.i;
          const nombre = fincas[i]?.nombre || '';
          fincas.splice(i,1);
          saveLists();
          renderFincasTable(); renderFincasDatalist(); renderFincaSelectParaLote();
          if ((origenFinca.value||'').toLowerCase() === nombre.toLowerCase()) actualizarLotesOrigen();
          if ((destinoFinca.value||'').toLowerCase() === nombre.toLowerCase()) actualizarLotesDestino();
        });
      });

      // Borrar lote puntual (requiere admin)
      tFin.querySelectorAll('button[data-f][data-l]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          if(!isAdmin){ alert('Solo el administrador puede modificar Fincas & Lotes'); return; }
          const fi = +btn.getAttribute('data-f');
          const li = +btn.getAttribute('data-l');
          const finca = fincas[fi];
          if(!finca) return;
          const eliminado = finca.lotes.splice(li,1)[0];
          saveLists();
          renderFincasTable();
          if ((origenFinca.value||'').toLowerCase() === finca.nombre.toLowerCase()) actualizarLotesOrigen();
          if ((destinoFinca.value||'').toLowerCase() === finca.nombre.toLowerCase()) actualizarLotesDestino();
          setEstado(`Lote "${eliminado}" borrado de ${finca.nombre} ‚úî`);
        });
      });
    }

    // Datalist de Fincas
    function renderFincasDatalist(){
      dlFincas.innerHTML = '';
      fincas.slice().sort((a,b)=>a.nombre.localeCompare(b.nombre,'es',{sensitivity:'base'}))
        .forEach(f=>{
          const opt = document.createElement('option'); opt.value = f.nombre; dlFincas.appendChild(opt);
        });
    }

    function renderFincaSelectParaLote(){
      fincaParaLote.innerHTML = '';
      fincas.forEach((f,i)=>{
        const opt = document.createElement('option');
        opt.value = i; opt.textContent = f.nombre;
        fincaParaLote.appendChild(opt);
      });
    }

    // Lotes dependientes
    function lotesDe(nombreFinca){
      const f = fincas.find(x => x.nombre.toLowerCase() === (nombreFinca||'').toLowerCase());
      return f ? f.lotes : [];
    }
    function setDatalistOptions(datalistEl, arr){
      if(!datalistEl) return;
      datalistEl.innerHTML = '';
      arr.forEach(l=>{
        const opt = document.createElement('option');
        opt.value = l; datalistEl.appendChild(opt);
      });
    }
    function actualizarLotesOrigen(){
      const lotes = lotesDe((origenFinca.value||'').trim());
      setDatalistOptions(dlLotesOrigen, lotes);
    }
    function actualizarLotesDestino(){
      const lotes = lotesDe((destinoFinca.value||'').trim());
      setDatalistOptions(dlLotesDestino, lotes);
    }
    origenFinca.addEventListener('input', actualizarLotesOrigen);
    destinoFinca.addEventListener('input', actualizarLotesDestino);

    /* === Gesti√≥n listas (Camiones/Choferes/Fincas/Lotes) === */
    document.getElementById('btnAddCamion').addEventListener('click', ()=>{
      const nombre = document.getElementById('newCamion').value.trim();
      const placa  = document.getElementById('newPlaca').value.trim().toUpperCase();
      if(!nombre || !placa) return alert('Completa nombre y placa');
      if(camiones.some(c=>c.nombre===nombre || c.placa===placa)) return alert('Ya existe ese cami√≥n o placa');
      camiones.push({nombre, placa}); saveLists();
      document.getElementById('newCamion').value=''; document.getElementById('newPlaca').value='';
      renderCamionesTable(); populateSelects(); actualizarPlaca(); setEstado('Cami√≥n agregado ‚úî');
    });
    document.getElementById('btnClearCamiones').addEventListener('click', ()=>{
      if(confirm('¬øBorrar TODOS los camiones?')){ camiones=[]; saveLists(); renderCamionesTable(); populateSelects(); actualizarPlaca(); }
    });

    document.getElementById('btnAddChofer').addEventListener('click', ()=>{
      const nombre = document.getElementById('newChofer').value.trim();
      if(!nombre) return alert('Escribe el nombre del chofer');
      if(choferes.includes(nombre)) return alert('Ese chofer ya existe');
      choferes.push(nombre); saveLists();
      document.getElementById('newChofer').value='';
      renderChoferesTable(); populateSelects(); setEstado('Chofer agregado ‚úî');
    });
    document.getElementById('btnClearChoferes').addEventListener('click', ()=>{
      if(confirm('¬øBorrar TODOS los choferes?')){ choferes=[]; saveLists(); renderChoferesTable(); populateSelects(); }
    });

    document.getElementById('btnAddFinca').addEventListener('click', ()=>{
      if(!isAdmin){ alert('Solo el administrador puede modificar Fincas & Lotes'); return; }
      const nombre = document.getElementById('newFinca').value.trim();
      if(!nombre) return alert('Escribe el nombre de la finca');
      if(fincas.some(f=>f.nombre.toLowerCase()===nombre.toLowerCase()))
        return alert('Esa finca ya existe');
      fincas.push({nombre, lotes:[]}); document.getElementById('newFinca').value='';
      saveLists(); renderFincasTable(); renderFincasDatalist(); renderFincaSelectParaLote();
      setEstado('Finca agregada ‚úî');
    });
    document.getElementById('btnClearFincas').addEventListener('click', ()=>{
      if(!isAdmin){ alert('Solo el administrador puede modificar Fincas & Lotes'); return; }
      if(confirm('¬øBorrar TODAS las fincas y sus lotes?')){
        fincas=[]; saveLists(); renderFincasTable(); renderFincasDatalist(); renderFincaSelectParaLote();
        actualizarLotesOrigen(); actualizarLotesDestino();
      }
    });
    document.getElementById('btnAddLote').addEventListener('click', ()=>{
      if(!isAdmin){ alert('Solo el administrador puede modificar Fincas & Lotes'); return; }
      const i = +fincaParaLote.value||0;
      const f = fincas[i];
      const lote = (document.getElementById('newLote').value||'').trim();
      if(!f) return alert('Elige una finca');
      if(!lote) return alert('Escribe el nombre del lote');
      if(f.lotes.some(l=>l.toLowerCase()===lote.toLowerCase()))
        return alert('Ese lote ya existe en la finca');
      f.lotes.push(lote);
      document.getElementById('newLote').value='';
      saveLists(); renderFincasTable();
      if((origenFinca.value||'').toLowerCase()===f.nombre.toLowerCase()) actualizarLotesOrigen();
      if((destinoFinca.value||'').toLowerCase()===f.nombre.toLowerCase()) actualizarLotesDestino();
      setEstado('Lote agregado ‚úî');
    });

    /* === CSV helpers === */
    function readFileText(file){
      return new Promise((res, rej)=>{
        const r = new FileReader(); r.onload=()=>res(r.result); r.onerror=()=>rej(r.error); r.readAsText(file);
      });
    }
    function parseCSV(text){
      const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
      if(!lines.length) return [];
      const header = lines[0].split(/[;,]/).map(h => h.trim().replace(/^"|"$/g,'').toLowerCase());
      const idxFinca = header.indexOf('finca');
      const idxLote  = header.indexOf('lote');
      let start = (idxFinca !== -1 && idxLote !== -1) ? 1 : 0;
      const rows = [];
      for(let i=start;i<lines.length;i++){
        const cols = lines[i].split(/[;,]/).map(c => c.trim().replace(/^"|"$/g,''));
        const finca = (idxFinca !== -1 ? cols[idxFinca] : cols[0]) || '';
        const lote  = (idxLote  !== -1 ? cols[idxLote]  : cols[1]) || '';
        if(!finca || !lote) continue;
        rows.push({ finca, lote });
      }
      return rows;
    }
    function mergeFincas(rows){
      let addedFincas = 0, addedLotes = 0;
      const lookup = new Map();
      fincas.forEach(f => lookup.set(f.nombre.toLowerCase(), f));
      for(const {finca, lote} of rows){
        const fn = finca.trim(); const ln = lote.trim();
        if(!fn || !ln) continue;
        const key = fn.toLowerCase();
        let f = lookup.get(key);
        if(!f){ f = { nombre: fn, lotes: [] }; fincas.push(f); lookup.set(key, f); addedFincas++; }
        if(!f.lotes.some(x => x.toLowerCase() === ln.toLowerCase())){ f.lotes.push(ln); addedLotes++; }
      }
      fincas.sort((a,b)=>a.nombre.localeCompare(b.nombre,'es',{sensitivity:'base'}));
      fincas.forEach(f=>f.lotes.sort((a,b)=>a.localeCompare(b,'es',{sensitivity:'base'})));
      saveLists(); return { addedFincas, addedLotes };
    }
    function buildCSVFromFincas(){
      const rows = [['finca','lote']];
      fincas.forEach(f=> f.lotes.forEach(l=> rows.push([f.nombre, l])));
      return rows.map(r => r.map(v => /[",;\n]/.test(v) ? `"${v.replace(/"/g,'""')}"` : v).join(',')).join('\n');
    }
    function downloadText(filename, text){
      const blob = new Blob([text], {type:'text/csv;charset=utf-8'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }
    function plantillaCSV(){
      const txt = `finca,lote
Cuyo,Lote 1
Cuyo,Lote 2
Buenavista,Lote 1
Buenavista,Lote 2`;
      downloadText('plantilla_fincas_lotes.csv', txt);
    }

    // Importar / Exportar (importar requiere admin; exportar permitido a todos para consulta)
    document.getElementById('btnImportCSV').addEventListener('click', async ()=>{
      if(!isAdmin){ alert('Solo el administrador puede modificar Fincas & Lotes'); return; }
      const inp = document.getElementById('csvFincas');
      const file = inp?.files?.[0];
      if(!file) return alert('Selecciona un archivo .csv');
      try{
        const text = await readFileText(file);
        const rows = parseCSV(text);
        if(!rows.length) return setEstado('CSV sin filas v√°lidas', false);
        const { addedFincas, addedLotes } = mergeFincas(rows);
        renderFincasTable(); renderFincasDatalist(); renderFincaSelectParaLote(); actualizarLotesOrigen(); actualizarLotesDestino();
        setEstado(`Importado: fincas +${addedFincas}, lotes +${addedLotes} ‚úî`);
        inp.value = '';
      }catch(e){ console.error(e); setEstado('Error leyendo el CSV', false); }
    });
    document.getElementById('btnImportText').addEventListener('click', ()=>{
      if(!isAdmin){ alert('Solo el administrador puede modificar Fincas & Lotes'); return; }
      const txt = (document.getElementById('csvText').value || '').trim();
      if(!txt) return alert('Pega alguna fila con formato finca,lote');
      const rows = parseCSV(txt);
      if(!rows.length) return setEstado('Texto sin filas v√°lidas', false);
      const { addedFincas, addedLotes } = mergeFincas(rows);
      renderFincasTable(); renderFincasDatalist(); renderFincaSelectParaLote(); actualizarLotesOrigen(); actualizarLotesDestino();
      setEstado(`Importado (texto): fincas +${addedFincas}, lotes +${addedLotes} ‚úî`);
      document.getElementById('csvText').value = '';
    });
    document.getElementById('btnExportCSV').addEventListener('click', ()=>{
      const csv = buildCSVFromFincas(); downloadText('fincas_lotes.csv', csv);
    });
    document.getElementById('btnPlantillaCSV').addEventListener('click', plantillaCSV);

    /* === Selects Viajes (cami√≥n/chofer) === */
    function populateSelects(){
      const selC = document.getElementById('camionSel');
      const selH = document.getElementById('choferSel');
      selC.innerHTML = '';
      camiones.forEach((c,i)=>{
        const opt = document.createElement('option'); opt.value = i; opt.textContent = `${c.nombre} (${c.placa})`;
        selC.appendChild(opt);
      });
      selH.innerHTML = '';
      choferes.forEach(ch=>{
        const opt = document.createElement('option'); opt.value = ch; opt.textContent = ch;
        selH.appendChild(opt);
      });
    }
    function actualizarPlaca(){
      const i = +document.getElementById('camionSel').value || 0;
      const c = camiones[i]; document.getElementById('placa').value = c ? c.placa : '';
    }
    document.getElementById('camionSel').addEventListener('change', actualizarPlaca);

    /* === VIAJES === */
    function leerFormulario(){
      const i = +document.getElementById('camionSel').value || 0;
      const c = camiones[i] || {nombre:'', placa:''};
      const oF = (origenFinca.value||'').trim(),  oL = (origenLote.value||'').trim();
      const dF = (destinoFinca.value||'').trim(), dL = (destinoLote.value||'').trim();
      return {
        usuario: who || '',
        fecha: document.getElementById('fecha').value,
        camion: c.nombre,
        placa: c.placa,
        chofer: document.getElementById('choferSel').value,
        origen:  oF ? (oL ? `${oF} - ${oL}` : oF) : '',
        destino: dF ? (dL ? `${dF} - ${dL}` : dF) : '',
        salida: document.getElementById('salida').value,
        llegada: document.getElementById('llegada').value,
        obs: (document.getElementById('obs').value||'').trim()
      };
    }
    function agregarFilaLocal(d){
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${d.fecha}</td><td>${d.camion}</td><td>${d.placa}</td><td>${d.chofer}</td>
                      <td>${d.origen}</td><td>${d.destino}</td><td>${d.salida}</td><td>${d.llegada}</td><td>${d.obs}</td>`;
      tbody.prepend(tr);
    }
    function limpiarFormulario(){
      document.getElementById('fecha').value = hoyISO();
      origenFinca.value=''; destinoFinca.value=''; origenLote.value=''; destinoLote.value='';
      setDatalistOptions(dlLotesOrigen, []); setDatalistOptions(dlLotesDestino, []);
      document.getElementById('salida').value=''; document.getElementById('llegada').value='';
      document.getElementById('obs').value='';
      document.getElementById('camionSel').selectedIndex = 0;
      document.getElementById('choferSel').selectedIndex = 0;
      actualizarPlaca();
      setEstado('Formulario limpio');
    }

    function enqueue(payload){
      const q = JSON.parse(localStorage.getItem(QKEY)||'[]'); q.push(payload);
      localStorage.setItem(QKEY, JSON.stringify(q));
    }
    async function enviar(payload){
      return fetch(ENDPOINT, {
        method:'POST',
        mode:'no-cors',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
    }

    // GUARDAR: SOLO COLA LOCAL
    function guardar(){
      const data = leerFormulario();
      if(!data.fecha || !data.camion || !data.placa || !data.chofer){
        setEstado('Falta fecha / cami√≥n / placa / chofer', false); return;
      }
      enqueue(data);
      agregarFilaLocal(data);
      setEstado('Guardado localmente. Pendiente de sincronizar.');
      limpiarFormulario();
    }

    // SINCRONIZAR: ENV√çA COLA
    async function sincronizar(){
      const q = JSON.parse(localStorage.getItem(QKEY)||'[]');
      if(!q.length) return setEstado('No hay pendientes');
      let ok=0;
      while(q.length){
        try{ await enviar(q[0]); q.shift(); ok++; localStorage.setItem(QKEY, JSON.stringify(q)); }
        catch(e){ setEstado('Error de red. Quedan pendientes.', false); break; }
      }
      setEstado(`Sincronizados: ${ok}. Pendientes: ${q.length}`, ok>0);
    }

    // PDF simple del primer registro visible
    function descargarPDF(){
      const filas = tbody.querySelectorAll('tr');
      if(!filas.length) return setEstado('No hay datos para PDF', false);
      const tds = filas[0].querySelectorAll('td');
      const texto = `Control de Camiones
Fecha: ${tds[0].textContent}
Cami√≥n: ${tds[1].textContent}  Placa: ${tds[2].textContent}
Chofer: ${tds[3].textContent}
Origen: ${tds[4].textContent}  Destino: ${tds[5].textContent}
Salida: ${tds[6].textContent}  Llegada: ${tds[7].textContent}
Obs: ${tds[8].textContent}`;
      const blob = new Blob([texto], {type:'application/pdf'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download=`control_camiones_${Date.now()}.pdf`;
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }

    /* === Eventos === */
    document.getElementById('btnGuardar').addEventListener('click', guardar);
    document.getElementById('btnLimpiar').addEventListener('click', limpiarFormulario);
    document.getElementById('btnSync').addEventListener('click', sincronizar);
    document.getElementById('btnPDF').addEventListener('click', descargarPDF);

    /* === INIT === */
    function populateSelects(){
      const selC = document.getElementById('camionSel');
      const selH = document.getElementById('choferSel');
      selC.innerHTML = '';
      camiones.forEach((c,i)=>{
        const opt = document.createElement('option'); opt.value = i; opt.textContent = `${c.nombre} (${c.placa})`;
        selC.appendChild(opt);
      });
      selH.innerHTML = '';
      choferes.forEach(ch=>{
        const opt = document.createElement('option'); opt.value = ch; opt.textContent = ch;
        selH.appendChild(opt);
      });
    }

    function init(){
      loadLists();
      renderCamionesTable();
      renderChoferesTable();
      renderFincasTable();
      renderFincasDatalist();
      renderFincaSelectParaLote();
      populateSelects();
      document.getElementById('fecha').value = hoyISO();
      actualizarPlaca();
      actualizarLotesOrigen();
      actualizarLotesDestino();

      // Admin lock al iniciar
      loadAdminState();

      // Dejar visible Viajes
      document.querySelectorAll('section[id^="tab-"]').forEach(s=>s.style.display='none');
      document.getElementById('tab-viajes').style.display='block';
      document.querySelector('.tabbtn[data-tab="viajes"]').classList.add('active');
    }
    init();
  </script>
</body>
</html>
