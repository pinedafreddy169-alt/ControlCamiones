<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Camiones BYC ‚Äî Modo Oscuro</title>
<style>
:root{--bg:#0f1115;--panel:#151923;--muted:#8a90a2;--text:#e8ecf1;--accent:#5ea1ff;--danger:#ff5e7a;--ok:#2bd27f;--border:#232838}
*{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif}
.wrap{max-width:1100px;margin:0 auto;padding:20px} h1{font-size:1.9rem;margin:0 0 6px}.lead{color:var(--muted);margin:0 0 16px}
.card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:16px}
.tabs{display:flex;gap:8px;flex-wrap:wrap;margin:0 0 12px}
.tab{padding:10px 14px;border:1px solid var(--border);border-radius:10px;background:#111524;color:var(--muted);cursor:pointer}
.tab.active{background:var(--accent);color:#07111f;border-color:transparent;font-weight:700}
label{font-size:.9rem;color:var(--muted)}
input,select,textarea{width:100%;padding:12px;border-radius:12px;border:1px solid var(--border);background:#0c0f17;color:var(--text)}
textarea{min-height:84px}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
.row{margin-bottom:12px}.actions{display:flex;gap:10px;flex-wrap:wrap}
button{padding:12px 14px;border:0;border-radius:12px;cursor:pointer;font-weight:700}
.btn{background:#1b2233;color:var(--text);border:1px solid var(--border)} .primary{background:var(--accent);color:#051226}
.danger{background:var(--danger);color:#22070c} .muted{color:var(--muted)} .ok{color:var(--ok);font-weight:700} .error{color:var(--danger)}
table{width:100%;border-collapse:collapse;margin-top:10px} th,td{border:1px solid var(--border);padding:8px;font-size:.95rem} th{background:#101525;color:var(--muted);text-align:left}
@media(max-width:900px){.grid2,.grid3{grid-template-columns:1fr}}
@media print{body{background:#fff;color:#000}.tabs,.actions,.lead{display:none}.card{border:0}}
</style>
</head>
<body>
<div class="wrap">
  <h1>Camiones BYC</h1>
  <p class="lead">Finca‚ÜíLote dependiente, choferes, camiones, borradores y sincronizaci√≥n.</p>

  <div class="tabs">
    <button class="tab active" data-tab="viaje">Registrar viaje</button>
    <button class="tab" data-tab="borradores">Borradores</button>
    <button class="tab" data-tab="choferes">Choferes</button>
    <button class="tab" data-tab="fincas">Fincas & Lotes</button>
    <button class="tab" data-tab="camiones">Camiones</button>
    <button class="tab" data-tab="sincronizar">Sincronizar</button>
    <button class="tab" data-tab="usuario">Usuario</button>
  </div>

  <!-- Registrar viaje -->
  <section id="viaje" class="card">
    <div class="grid3 row">
      <div><label>Fecha</label><input type="date" id="v_fecha"></div>
      <div><label>Chofer</label><select id="v_chofer"></select></div>
      <div><label>Cami√≥n</label><select id="v_camion"></select></div>
    </div>
    <div class="grid2 row">
      <div><label>Placa (auto)</label><input type="text" id="v_placa" readonly></div>
      <div><label>Operador</label><input type="text" id="v_user" placeholder="Tu nombre"></div>
    </div>

    <div class="row"><strong>Origen</strong></div>
    <div class="grid2 row">
      <div><label>Finca (origen)</label><select id="o_finca"></select></div>
      <div><label>Lote (origen)</label><select id="o_lote"></select></div>
    </div>

    <div class="row"><strong>Destino</strong></div>
    <div class="grid2 row">
      <div><label>Finca (destino)</label><select id="d_finca"></select></div>
      <div><label>Lote (destino)</label><select id="d_lote"></select></div>
    </div>

    <div class="grid2 row">
      <div><label>Hora salida</label><input type="time" id="v_salida"></div>
      <div><label>Hora llegada</label><input type="time" id="v_llegada"></div>
    </div>

    <div class="row"><label>Observaciones</label><textarea id="v_obs" placeholder="Notas del viaje"></textarea></div>

    <div class="actions">
      <button class="primary" id="btnBorrador">Guardar borrador</button>
      <button class="btn" id="btnEnviar" data-label="Enviar directo a Excel">Enviar directo a Excel</button>
      <button class="btn" id="btnLimpiar">Limpiar</button>
      <span id="estadoEnvio" class="muted"></span>
    </div>
  </section>

  <!-- Borradores -->
  <section id="borradores" class="card" hidden>
    <div class="actions">
      <button class="primary" id="btnSyncBorradores">Sincronizar todos</button>
      <span id="estadoBor" class="muted"></span>
    </div>
    <div id="tablaBor" class="row"></div>
  </section>

  <!-- Choferes -->
  <section id="choferes" class="card" hidden>
    <div class="row grid2">
      <div><label>Nuevo chofer</label><input type="text" id="c_nuevo"></div>
      <div style="display:flex;align-items:end"><button class="primary" id="c_add">Agregar</button></div>
    </div>
    <div id="c_lista"></div>
  </section>

  <!-- Fincas & Lotes -->
  <section id="fincas" class="card" hidden>
    <div class="row grid2">
      <div><label>Nueva finca</label><input type="text" id="f_nueva"></div>
      <div style="display:flex;align-items:end"><button class="primary" id="f_add">Agregar finca</button></div>
    </div>
    <div id="f_lista" class="row"></div>
    <div class="row grid3">
      <div><label>Lote (texto)</label><input type="text" id="l_nuevo"></div>
      <div><label>Asignar a finca</label><select id="l_fincaSel"></select></div>
      <div style="display:flex;align-items:end"><button class="primary" id="l_add">Agregar lote</button></div>
    </div>
    <div id="l_lista"></div>
  </section>

  <!-- Camiones -->
  <section id="camiones" class="card" hidden>
    <div class="row grid2">
      <div><label>Cami√≥n</label><input type="text" id="m_camion"></div>
      <div><label>Placa</label><input type="text" id="m_placa"></div>
    </div>
    <div class="actions"><button class="primary" id="m_add">Agregar cami√≥n</button></div>
    <div id="m_lista" class="row"></div>
  </section>

  <!-- Sincronizar -->
  <section id="sincronizar" class="card" hidden>
    <div class="actions">
      <button class="primary" id="btnSync">üîÑ Leer hoja</button>
      <button class="btn" id="btnEnviarPendientes">Enviar pendientes</button>
      <span id="estadoSync" class="muted"></span>
    </div>
    <div id="tabla"></div>
  </section>

  <!-- Usuario -->
  <section id="usuario" class="card" hidden>
    <div class="grid2 row">
      <div><label>Usuario/Operador</label><input type="text" id="u_nombre" placeholder="Ej. Freddy"></div>
      <div style="display:flex;align-items:end"><button class="primary" id="u_guardar">Guardar</button></div>
    </div>
  </section>
</div>

<script>
/* ===== CONFIG ===== */
const GAS_URL = "https://script.google.com/macros/s/AKfycbyjDY7j7ehoQ7crRAh2tLT_PnRvVT384_YmUmJ5JOmwP8jBH23x45CksGy3plcsM5nLcg/exec";

/* ===== UTIL ===== */
const $=s=>document.querySelector(s), $$=s=>document.querySelectorAll(s);
const store={get:(k,d)=>{try{const v=localStorage.getItem(k);return v?JSON.parse(v):d;}catch{return d}},set:(k,v)=>localStorage.setItem(k,JSON.stringify(v))};
function todayISO(){const d=new Date();d.setHours(0,0,0,0);return d.toISOString().slice(0,10)}
function toast(el,msg,ok=true){el.textContent=msg;el.className=ok?'ok':'error';setTimeout(()=>{el.textContent='';el.className='muted'},3000)}
function setBtnLoading(btn,loading,label){if(!btn)return;if(loading){btn.disabled=true;btn.textContent='Enviando‚Ä¶'}else{btn.disabled=false;btn.textContent=label||btn.dataset.label||'Enviar'}}

/* ===== DATOS ===== */
let usuario=store.get("byc_user","");
let choferes=store.get("byc_choferes",["Freddy","Tatiana","Javier"]);
let camiones=store.get("byc_camiones",[{"camion":"Cami√≥n 01","placa":"ABC-123"}]);
let pendientes=store.get("byc_pendientes",[]), borradores=store.get("byc_borradores",[]);

/* ===== LOTES OFICIALES (deduplicados) ===== */
const LOTES_RAW = [
  {finca:"Buena Vista",lote:"Lote 001"},{finca:"Buena Vista",lote:"Lote 002"},{finca:"Buena Vista",lote:"Lote 003"},
  {finca:"Buena Vista",lote:"Lote 005"},{finca:"Buena Vista",lote:"Lote 007"},{finca:"Buena Vista",lote:"Lote 008"},
  {finca:"Buena Vista",lote:"Lote 009"},{finca:"Buena Vista",lote:"Lote 011"},{finca:"Buena Vista",lote:"Lote 014"},
  {finca:"Buena Vista",lote:"Lote 015"},{finca:"Buena Vista",lote:"Lote 016"},
  {finca:"Ca√±o Blanco",lote:"Lote 001"},{finca:"Ca√±o Blanco",lote:"Lote 002"},{finca:"Ca√±o Blanco",lote:"Lote 003"},
  {finca:"Ca√±o Blanco",lote:"Lote 004"},{finca:"Ca√±o Blanco",lote:"Lote 005"},{finca:"Ca√±o Blanco",lote:"Lote 006"},
  {finca:"Ca√±o Blanco",lote:"Lote 007"},{finca:"Ca√±o Blanco",lote:"Lote 008"},{finca:"Ca√±o Blanco",lote:"Lote 009"},{finca:"Ca√±o Blanco",lote:"Lote 011"},
  {finca:"Chorcha",lote:"Lote 001"},
  {finca:"Don Cuyo",lote:"Lote 001"},{finca:"Don Cuyo",lote:"Lote 002"},{finca:"Don Cuyo",lote:"Lote 003"},{finca:"Don Cuyo",lote:"Lote 004"},
  {finca:"Enrique",lote:"Lote 001"},{finca:"Enrique",lote:"Lote 002"},
  {finca:"Guayabito",lote:"Lote 001"},{finca:"Guayabito",lote:"Lote 002"},{finca:"Guayabito",lote:"Lote 003"},{finca:"Guayabito",lote:"Lote 004"},
  {finca:"Guayabito",lote:"Lote 005"},{finca:"Guayabito",lote:"Lote 006"},{finca:"Guayabito",lote:"Lote 011"},{finca:"Guayabito",lote:"Lote 012"},
  {finca:"Guayabito",lote:"Lote 014"},{finca:"Guayabito",lote:"Lote 015"},{finca:"Guayabito",lote:"Lote 017"},{finca:"Guayabito",lote:"Lote 019"},
  {finca:"Guayabito",lote:"Lote 021"},{finca:"Guayabito",lote:"Lote 022"},{finca:"Guayabito",lote:"Lote 027"},
  {finca:"Los Abuelos",lote:"Lote 001"},{finca:"Los Angeles",lote:"Lote 001"},
  {finca:"Oscar",lote:"Lote 001"},{finca:"Oscar",lote:"Lote 002"},{finca:"Oscar",lote:"Lote 003"},
  {finca:"Pajarilla",lote:"Lote 001"},
  {finca:"Pataste",lote:"Lote 001"},{finca:"Pataste",lote:"Lote 002"},{finca:"Pataste",lote:"Lote 003"},{finca:"Pataste",lote:"Lote 004"},
  {finca:"Pataste",lote:"Lote 006"},{finca:"Pataste",lote:"Lote 007"},{finca:"Pataste",lote:"Lote 008"},
  {finca:"Progreso",lote:"Lote 001"},{finca:"Progreso",lote:"Lote 002"},{finca:"Progreso",lote:"Lote 003"},{finca:"Progreso",lote:"Lote 004"},{finca:"Progreso",lote:"Lote 005"},
  {finca:"Rescate",lote:"Lote 001"},{finca:"Rescate",lote:"Lote 004"},{finca:"Rescate",lote:"Lote 005"},{finca:"Rescate",lote:"Lote 006"},
  {finca:"Rescate",lote:"Lote 007"},{finca:"Rescate",lote:"Lote 008"},{finca:"Rescate",lote:"Lote 013"},
  {finca:"San Luis",lote:"Lote 001"},{finca:"Tuto",lote:"Lote 001"}
];
const _map=new Map(LOTES_RAW.map(r=>[r.finca+"|"+r.lote,r])); let lotes=Array.from(_map.values());
let fincas=[...new Set(lotes.map(r=>r.finca))].sort();
// Actualiza 1 vez en todos los celulares
const DATA_VERSION=3;
if(store.get("byc_version",0)<DATA_VERSION){store.set("byc_fincas",fincas);store.set("byc_lotes",lotes);store.set("byc_version",DATA_VERSION)}
else{fincas=store.get("byc_fincas",fincas);lotes=store.get("byc_lotes",lotes)}

/* ===== TABS ===== */
$$(".tab").forEach(b=>{b.onclick=()=>{$$(".tab").forEach(x=>x.classList.remove("active"));b.classList.add("active");
["viaje","borradores","choferes","fincas","camiones","sincronizar","usuario"].forEach(id=>$("#"+id).hidden=(id!==b.dataset.tab));
if(b.dataset.tab==="borradores") renderBorradores();};});

/* ===== SELECTS CHOFER/CAMION ===== */
function renderChoferes(){ $("#v_chofer").innerHTML=choferes.map(n=>`<option value="${n}">${n}</option>`).join("") }
function renderCamiones(){ $("#v_camion").innerHTML=camiones.map(c=>`<option value="${c.camion}">${c.camion}</option>`).join(""); fillPlacaFromCamion(); }
function fillPlacaFromCamion(){ const v=$("#v_camion").value; const f=camiones.find(c=>c.camion===v); $("#v_placa").value=f?f.placa:"" }

/* ===== FINCA ‚Üí LOTE (corregido) ===== */
// Construye las fincas UNA SOLA VEZ
function buildFincaSelect(sel, defFinca){
  const s=document.querySelector(sel);
  s.innerHTML=fincas.map(f=>`<option value="${f}">${f}</option>`).join("");
  s.value = defFinca && fincas.includes(defFinca) ? defFinca : (fincas[0]||"");
}
// Actualiza lotes seg√∫n la finca seleccionada (NO toca el select de fincas)
function updateLotes(fincaSel,loteSel, defLote){
  const sF=document.querySelector(fincaSel), sL=document.querySelector(loteSel);
  const arr=lotes.filter(x=>x.finca===sF.value);
  sL.innerHTML=arr.map(x=>`<option value="${x.lote}">${x.lote}</option>`).join("");
  sL.value = (defLote && arr.some(x=>x.lote===defLote)) ? defLote : (arr[0]?.lote||"");
}
function initOrigenDestino(){
  // por defecto Ca√±o Blanco
  buildFincaSelect("#o_finca","Ca√±o Blanco");
  buildFincaSelect("#d_finca","Ca√±o Blanco");
  updateLotes("#o_finca","#o_lote");
  updateLotes("#d_finca","#d_lote");
  $("#o_finca").addEventListener("change",()=>updateLotes("#o_finca","#o_lote"));
  $("#d_finca").addEventListener("change",()=>updateLotes("#d_finca","#d_lote"));
}

/* ===== ADMIN ===== */
function renderAdminChoferes(){ $("#c_lista").innerHTML=choferes.map((n,i)=>`<div class="row grid2"><input value="${n}" disabled><button class="danger" onclick="delChofer(${i})">Eliminar</button></div>`).join("")||'<p class="muted">Sin choferes.</p>' }
function delChofer(i){ choferes.splice(i,1); store.set("byc_choferes",choferes); renderChoferes(); renderAdminChoferes() }
function renderAdminFincasLotes(){
  $("#f_lista").innerHTML=fincas.map((f,i)=>`<div class="row grid2"><input value="${f}" disabled><button class="danger" onclick="delFinca(${i})">Eliminar</button></div>`).join("")||'<p class="muted">Sin fincas.</p>';
  $("#l_fincaSel").innerHTML=fincas.map(f=>`<option value="${f}">${f}</option>`).join("");
  let html=""; fincas.forEach(f=>{html+=`<h4 style="margin:10px 0 6px">${f}</h4>`; const arr=lotes.filter(x=>x.finca===f);
    if(!arr.length){html+='<p class="muted">Sin lotes</p>';return;}
    html+='<div class="grid3">'+arr.map(x=>{const i=lotes.indexOf(x);return `<div class="row"><input value="${x.lote}" disabled><button class="danger" onclick="delLote(${i})">Eliminar</button></div>`}).join("")+'</div>';});
  $("#l_lista").innerHTML=html;
}
function delFinca(i){const nombre=fincas[i]; fincas.splice(i,1); lotes=lotes.filter(x=>x.finca!==nombre); store.set("byc_fincas",fincas); store.set("byc_lotes",lotes); renderAdminFincasLotes(); initOrigenDestino();}
function delLote(i){lotes.splice(i,1); store.set("byc_lotes",lotes); renderAdminFincasLotes(); initOrigenDestino();}
$("#c_add").onclick=()=>{const v=$("#c_nuevo").value.trim(); if(!v) return; if(!choferes.includes(v)) choferes.push(v); store.set("byc_choferes",choferes); $("#c_nuevo").value=""; renderChoferes(); renderAdminChoferes()}
$("#f_add").onclick=()=>{const v=$("#f_nueva").value.trim(); if(!v) return; if(!fincas.includes(v)) fincas.push(v); store.set("byc_fincas",fincas); $("#f_nueva").value=""; renderAdminFincasLotes(); initOrigenDestino()}
$("#l_add").onclick=()=>{const lote=$("#l_nuevo").value.trim(); const finca=$("#l_fincaSel").value; if(!lote||!finca) return; lotes.push({finca,lote}); store.set("byc_lotes",lotes); $("#l_nuevo").value=""; renderAdminFincasLotes(); initOrigenDestino()}
$("#m_add").onclick=()=>{const c=$("#m_camion").value.trim(); const p=$("#m_placa").value.trim(); if(!c||!p) return; camiones.push({camion:c,placa:p}); store.set("byc_camiones",camiones); $("#m_camion").value=""; $("#m_placa").value=""; renderAdminCamiones()}
function renderAdminCamiones(){ $("#m_lista").innerHTML=camiones.map((c,i)=>`<div class="row grid3"><input value="${c.camion}" disabled><input value="${c.placa}" disabled><button class="danger" onclick="delCamion(${i})">Eliminar</button></div>`).join("")||'<p class="muted">Sin camiones.</p>'; renderCamiones() }
function delCamion(i){camiones.splice(i,1); store.set("byc_camiones",camiones); renderAdminCamiones()}

/* ===== INICIALIZA ===== */
$$(".tab").forEach(()=>{}); // noop para Safari viejo
renderChoferes(); renderAdminChoferes(); renderAdminCamiones(); renderAdminFincasLotes();
if(usuario){$("#u_nombre").value=usuario; $("#v_user").value=usuario}
const f=document.getElementById('v_fecha'); if(f&&!f.value) f.value=todayISO();
initOrigenDestino();
$("#v_camion").addEventListener("change",fillPlacaFromCamion);

/* ===== FORMULARIO ===== */
function leerViaje(){
  const oText=($("#o_finca").value||"") + ($("#o_lote").value?(" / "+$("#o_lote").value):"");
  const dText=($("#d_finca").value||"") + ($("#d_lote").value?(" / "+$("#d_lote").value):"");
  return {fecha:$("#v_fecha").value||todayISO(),camion:$("#v_camion").value,placa:$("#v_placa").value,
    chofer:$("#v_chofer").value,operador:$("#v_user").value||usuario,origen:oText,destino:dText,
    origen_finca:$("#o_finca").value,origen_lote:$("#o_lote").value,destino_finca:$("#d_finca").value,destino_lote:$("#d_lote").value,
    salida:$("#v_salida").value,llegada:$("#v_llegada").value,observaciones:$("#v_obs").value,_ts:Date.now()}
}
$("#btnLimpiar").onclick=()=>{$$("#viaje input,#viaje textarea").forEach(e=>{if(e.id!=="v_user") e.value=""}); if(usuario) $("#v_user").value=usuario}

/* ===== BORRADORES SENCILLOS ===== */
let editIndex=-1;
function renderBorradores(){
  const cont=$("#tablaBor"); if(!borradores.length){cont.innerHTML="<p class='muted'>No hay borradores.</p>"; return}
  const cols=["fecha","camion","placa","chofer","origen","destino","salida","llegada","observaciones"];
  let html="<table><thead><tr>"+cols.map(c=>`<th>${c.toUpperCase()}</th>`).join("")+"<th>Acciones</th></tr></thead><tbody>";
  borradores.forEach((r,i)=>{html+="<tr>"+cols.map(c=>`<td>${r[c]??""}</td>`).join("")+
    `<td><button class="btn" onclick="editarBor(${i})">Cargar</button>
         <button class="danger" onclick="eliminarBor(${i})">Eliminar</button>
         <button class="primary" onclick="enviarUno(${i})">Enviar</button></td></tr>`});
  html+="</tbody></table>"; cont.innerHTML=html
}
window.editarBor=i=>{const r=borradores[i]; editIndex=i; $("#v_fecha").value=r.fecha; $("#v_camion").value=r.camion; fillPlacaFromCamion();
$("#v_placa").value=r.placa; $("#v_chofer").value=r.chofer; $("#v_user").value=r.operador||usuario||"";
$("#o_finca").value=r.origen_finca||$("#o_finca").value; updateLotes("#o_finca","#o_lote",r.origen_lote);
$("#d_finca").value=r.destino_finca||$("#d_finca").value; updateLotes("#d_finca","#d_lote",r.destino_lote);
$("#v_salida").value=r.salida; $("#v_llegada").value=r.llegada; $("#v_obs").value=r.observaciones||""; document.querySelector('.tab[data-tab="viaje"]').click()}
window.eliminarBor=i=>{borradores.splice(i,1); store.set("byc_borradores",borradores); renderBorradores()}
window.enviarUno=async i=>{const r=borradores[i]; const ok=await enviarRegistro(r,false); if(ok){borradores.splice(i,1); store.set("byc_borradores",borradores); renderBorradores(); toast($("#estadoBor"),"Enviado ‚úÖ")} else toast($("#estadoBor"),"Sin internet.",false)}
$("#btnBorrador").onclick=()=>{const r=leerViaje(); if(editIndex>=0){borradores[editIndex]=r; editIndex=-1}else borradores.push(r); store.set("byc_borradores",borradores); toast($("#estadoEnvio"),"Borrador guardado ‚úÖ"); renderBorradores()}
$("#btnSyncBorradores").onclick=async()=>{const est=$("#estadoBor"); if(!borradores.length) return toast(est,"No hay borradores");
  let ok=0,fail=0,rest=[]; for(const r of borradores){const ex=await enviarRegistro(r,false); if(ex) ok++; else {fail++; rest.push(r)}}
  borradores=rest; store.set("byc_borradores",borradores); renderBorradores(); toast(est,`OK ${ok} / Error ${fail}`, fail===0)}

/* ===== ENV√çO (antidoble-click) ===== */
async function enviarRegistro(reg,showMsg=true){
  try{
    const body=new URLSearchParams({payload:JSON.stringify([reg])});
    const res=await fetch(GAS_URL,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body});
    const txt=await res.text(); let j; try{j=JSON.parse(txt)}catch{j={ok:res.ok,raw:txt}}
    if(!j.ok) throw new Error(j.error||JSON.stringify(j));
    if(showMsg) toast($("#estadoEnvio"),"Enviado ‚úÖ"); return true
  }catch(e){ if(showMsg) toast($("#estadoEnvio"),"Sin internet. Guardado en pendientes.",false); pendientes.push(reg); store.set("byc_pendientes",pendientes); return false }
}
let sending=false;
$("#btnEnviar").onclick=async()=>{
  if(sending) return; sending=true; setBtnLoading($("#btnEnviar"),true);
  const reg=leerViaje(); await enviarRegistro(reg,true);
  setTimeout(()=>{sending=false; setBtnLoading($("#btnEnviar"),false,$("#btnEnviar").dataset.label)},500);
};
$("#btnEnviarPendientes").onclick=async()=>{const est=$("#estadoSync"); if(!pendientes.length) return toast(est,"No hay pendientes");
  let ok=0,fail=0,nuevos=[]; for(const r of pendientes){const ex=await enviarRegistro(r,false); if(ex) ok++; else {fail++; nuevos.push(r)}}
  pendientes=nuevos; store.set("byc_pendientes",pendientes); toast(est,`Pendientes: OK ${ok} / Error ${fail}`, fail===0)}
$("#btnSync").onclick=async()=>{const est=$("#estadoSync"), tabla=$("#tabla"); est.textContent="Leyendo‚Ä¶";
  try{const res=await fetch(GAS_URL+"?action=getData"); const j=await res.json(); if(!j.ok) throw new Error(j.error||"Error");
    est.textContent=`Registros: ${j.data.length}`; const headers=(j.headers&&j.headers.length)?j.headers:Object.keys(j.data[0]||{});
    let html="<table><thead><tr>"+headers.map(h=>`<th>${h}</th>`).join("")+"</tr></thead><tbody>";
    j.data.forEach(r=>{html+="<tr>"+headers.map(h=>`<td>${r[h]??""}</td>`).join("")+"</tr>"}); html+="</tbody></table>"; tabla.innerHTML=html
  }catch(e){toast(est,String(e),false)}}

/* ===== USUARIO ===== */
$("#u_guardar").onclick=()=>{usuario=$("#u_nombre").value.trim(); store.set("byc_user",usuario); $("#v_user").value=usuario; alert("Usuario guardado.")}
</script>
</body>
</html>
