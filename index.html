<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Camiones BYC ‚Äî Antipega + Tiempos muertos</title>

<!-- PWA -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#151923">
<link rel="icon" href="icons/icon-192.png" sizes="192x192">
<link rel="icon" href="icons/icon-512.png" sizes="512x512">
<link rel="apple-touch-icon" href="icons/icon-192.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="apple-mobile-web-app-title" content="Camiones BYC">

<style>
:root{--bg:#0f1115;--panel:#151923;--muted:#8a90a2;--text:#e8ecf1;--accent:#5ea1ff;--danger:#ff5e7a;--ok:#2bd27f;--border:#232838}
*{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif}
.wrap{max-width:1100px;margin:0 auto;padding:20px} h1{font-size:1.9rem;margin:0 0 6px}.lead{color:var(--muted);margin:0 0 16px}
.card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:16px}
.tabs{display:flex;gap:8px;flex-wrap:wrap;margin:0 0 12px}
.tab{padding:10px 14px;border:1px solid var(--border);border-radius:10px;background:#111524;color:var(--muted);cursor:pointer}
.tab.active{background:var(--accent);color:#07111f;border-color:transparent;font-weight:700}
label{font-size:.9rem;color:var(--muted)}
input,select,textarea{width:100%;padding:12px;border-radius:12px;border:1px solid var(--border);background:#0c0f17;color:var(--text)}
textarea{min-height:84px}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
.row{margin-bottom:12px}.actions{display:flex;gap:10px;flex-wrap:wrap}
button{padding:12px 14px;border:0;border-radius:12px;cursor:pointer;font-weight:700}
.btn{background:#1b2233;color:var(--text);border:1px solid var(--border)} .primary{background:var(--accent);color:#051226}
.danger{background:var(--danger);color:#22070c} .muted{color:var(--muted)} .ok{color:var(--ok);font-weight:700} .error{color:var(--danger)}
table{width:100%;border-collapse:collapse;margin-top:10px} th,td{border:1px solid var(--border);padding:8px;font-size:.95rem} th{background:#101525;color:var(--muted);text-align:left}
@media(max-width:900px){.grid2,.grid3{grid-template-columns:1fr}}
@media print{body{background:#fff;color:#000}.tabs,.actions,.lead{display:none}.card{border:0}}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:.8rem;border:1px solid var(--border);background:#101525;color:var(--muted)}
.hr{height:1px;background:var(--border);margin:12px 0}
</style>
</head>
<body>
<div class="wrap">
  <h1>Camiones BYC <span class="badge">Antipega</span></h1>
  <p class="lead">Viajes, Tiempos muertos, borradores y sincronizaci√≥n con Google Sheets.</p>

  <div class="tabs">
    <button class="tab active" data-tab="viaje">Registrar viaje</button>
    <button class="tab" data-tab="tm">Tiempos muertos</button>
    <button class="tab" data-tab="borradores">Borradores</button>
    <button class="tab" data-tab="choferes">Choferes</button>
    <button class="tab" data-tab="fincas">Fincas & Lotes</button>
    <button class="tab" data-tab="camiones">Camiones</button>
    <button class="tab" data-tab="sincronizar">Sincronizar</button>
  </div>

  <!-- Registrar viaje -->
  <section id="viaje" class="card">
    <div class="grid3 row">
      <div><label>Fecha</label><input type="date" id="v_fecha"></div>
      <div><label>Chofer</label><select id="v_chofer"></select></div>
      <div><label>Cami√≥n</label><select id="v_camion"></select></div>
    </div>

    <!-- NUEVO: Qui√©n solicita -->
    <div class="grid2 row">
      <div>
        <label>Solicita (qui√©n pide el viaje)</label>
        <input id="v_solicita" list="solicitantes" placeholder="Ej. Don Leandro">
        <datalist id="solicitantes"></datalist>
      </div>
      <div>
        <label>Placa (auto)</label>
        <input type="text" id="v_placa" readonly>
      </div>
    </div>

    <div class="row"><strong>Origen</strong></div>
    <div class="grid2 row">
      <div><label>Finca (origen)</label><select id="o_finca"></select></div>
      <div><label>Lote (origen)</label><select id="o_lote"></select></div>
    </div>

    <div class="row"><strong>Destino</strong></div>
    <div class="grid2 row">
      <div><label>Finca (destino)</label><select id="d_finca"></select></div>
      <div><label>Lote (destino)</label><select id="d_lote"></select></div>
    </div>

    <div class="grid2 row">
      <div><label>Hora salida</label><input type="time" id="v_salida"></div>
      <div><label>Hora llegada</label><input type="time" id="v_llegada"></div>
    </div>

    <div class="row"><label>Observaciones</label><textarea id="v_obs" placeholder="Notas del viaje"></textarea></div>

    <div class="actions">
      <button class="primary" id="btnBorrador">Guardar borrador</button>
      <button class="btn" id="btnEnviar" data-label="Enviar directo a Excel">Enviar directo a Excel</button>
      <button class="btn" id="btnLimpiar">Limpiar</button>
      <span id="estadoEnvio" class="muted"></span>
    </div>
  </section>

  <!-- Tiempos muertos -->
  <section id="tm" class="card" hidden>
    <div class="grid3 row">
      <div><label>Fecha</label><input type="date" id="tm_fecha"></div>
      <div><label>Chofer</label><select id="tm_chofer"></select></div>
      <div><label>Cami√≥n</label><select id="tm_camion"></select></div>
    </div>
    <div class="grid2 row">
      <div><label>Placa (auto)</label><input type="text" id="tm_placa" readonly></div>
      <div><label>&nbsp;</label><input type="text" disabled placeholder="Rodando eliminado"></div>
    </div>

    <div class="grid2 row">
      <div><label>Hora inicio</label><input type="time" id="tm_inicio"></div>
      <div><label>Hora fin</label><input type="time" id="tm_fin"></div>
    </div>

    <div class="grid3 row">
      <div>
        <label>Labor / motivo</label>
        <select id="tm_labor">
          <option value="Esperando personal">Esperando personal</option>
          <option value="Mantenimiento del veh√≠culo">Mantenimiento del veh√≠culo</option>
          <option value="Lavado del veh√≠culo">Lavado del veh√≠culo</option>
          <option value="Carga de materiales">Carga de materiales</option>
          <option value="Descarga de materiales">Descarga de materiales</option>
          <option value="Carga y descarga">Carga y descarga</option>
          <option value="Repostaje de combustible">Repostaje de combustible</option>
          <option value="Documentaci√≥n / Papeleo">Documentaci√≥n / Papeleo</option>
          <option value="Inspecci√≥n / Revisi√≥n">Inspecci√≥n / Revisi√≥n</option>
          <option value="Otro">Otro‚Ä¶</option>
        </select>
      </div>
      <div><label>Si es ‚ÄúOtro‚Äù, especifique</label><input type="text" id="tm_labor_otro" placeholder="Detalle del motivo"></div>
      <div><label>&nbsp;</label><input type="text" disabled placeholder="Rodando eliminado"></div>
    </div>

    <div class="row"><label>Observaciones</label><textarea id="tm_obs" placeholder="Notas del tiempo muerto"></textarea></div>

    <div class="actions">
      <button class="primary" id="tm_btnBorrador">Guardar borrador</button>
      <button class="btn" id="tm_btnEnviar" data-label="Enviar TM a Excel">Enviar TM a Excel</button>
      <button class="btn" id="tm_btnLimpiar">Limpiar</button>
      <span id="tm_estadoEnvio" class="muted"></span>
    </div>

    <div class="hr"></div>

    <div class="actions">
      <button class="primary" id="tm_btnSyncBorradores">Sincronizar todos (TM)</button>
      <span id="tm_estadoBor" class="muted"></span>
    </div>
    <div id="tm_tablaBor" class="row"></div>
  </section>

  <!-- Borradores (Viajes) -->
  <section id="borradores" class="card" hidden>
    <div class="actions">
      <button class="primary" id="btnSyncBorradores">Sincronizar todos</button>
      <span id="estadoBor" class="muted"></span>
    </div>
    <div id="tablaBor" class="row"></div>
  </section>

  <!-- Choferes -->
  <section id="choferes" class="card" hidden>
    <div class="row grid2">
      <div><label>Nuevo chofer</label><input type="text" id="c_nuevo" placeholder="Nombre del chofer"></div>
      <div style="display:flex;align-items:end"><button class="primary" id="c_add">Agregar</button></div>
    </div>
    <div id="c_lista" class="row"></div>
  </section>

  <!-- Fincas & Lotes -->
  <section id="fincas" class="card" hidden>
    <div id="f_lock" class="row">
      <div class="grid3">
        <div><label>Estado</label><input id="admin_status" readonly value="Bloqueado ‚Äî solo lectura"></div>
        <div><label>Contrase√±a admin</label><input type="password" id="admin_pass" placeholder="ADMI 12345"></div>
        <div style="display:flex;align-items:end;gap:8px">
          <button class="btn" id="btnUnlock">Desbloquear</button>
          <button class="danger" id="btnLock" hidden>Bloquear</button>
        </div>
      </div>
      <p class="muted">Solo el administrador puede agregar/eliminar fincas y lotes.</p>
    </div>

    <div id="f_admin" hidden>
      <div class="row grid2">
        <div><label>Nueva finca</label><input type="text" id="f_nueva" placeholder="Ej. Buena Vista"></div>
        <div style="display:flex;align-items:end"><button class="primary" id="f_add">Agregar finca</button></div>
      </div>
      <div class="row grid3">
        <div><label>Lote (texto)</label><input type="text" id="l_nuevo" placeholder="Ej. Lote 007"></div>
        <div><label>Asignar a finca</label><select id="l_fincaSel"></select></div>
        <div style="display:flex;align-items:end"><button class="primary" id="l_add">Agregar lote</button></div>
      </div>
    </div>

    <div id="f_lista" class="row"></div>
    <div id="l_lista" class="row"></div>
  </section>

  <!-- Camiones -->
  <section id="camiones" class="card" hidden>
    <div class="row grid2">
      <div><label>Cami√≥n</label><input type="text" id="m_camion"></div>
      <div><label>Placa</label><input type="text" id="m_placa"></div>
    </div>
    <div class="actions"><button class="primary" id="m_add">Agregar cami√≥n</button></div>
    <div id="m_lista" class="row"></div>
  </section>

  <!-- Sincronizar -->
  <section id="sincronizar" class="card" hidden>
    <div class="actions">
      <button class="primary" id="btnSync">üîÑ Leer hoja</button>
      <button class="btn" id="btnEnviarPendientes">Enviar pendientes</button>
      <span id="estadoSync" class="muted"></span>
    </div>
    <div id="tabla"></div>
  </section>
</div>

<script>
/* ===== CONFIG ===== */
const GAS_URL = "https://script.google.com/macros/s/AKfycbyQOsvg9RiNDfCA3WNQiWZLmeVThFCKQfnWq9bkSx5uVxRKF3xFKznsx7qulC8ksYeHsA/exec";
const ADMIN_PASS_NORMALIZED = "admi12345";

/* ===== SEGURIDAD B√ÅSICA ===== */
window.onerror = (m)=>{ try{toast(document.getElementById('estadoEnvio')||document.body, "Error: "+m, false)}catch{}; return true; };
window.onunhandledrejection = (ev)=>{ try{toast(document.getElementById('estadoEnvio')||document.body, "Error: "+(ev.reason?.message||ev.reason), false)}catch{}; ev.preventDefault?.(); return true; };

/* ===== UTIL ===== */
const $=s=>document.querySelector(s), $$=s=>document.querySelectorAll(s);
function normalizePass(p){return (p||"").replace(/\s+/g,"").toLowerCase()}
function todayISO(){const d=new Date();d.setHours(0,0,0,0);return d.toISOString().slice(0,10)}
function toast(el,msg,ok=true){el.textContent=msg;el.className=ok?'ok':'error';setTimeout(()=>{el.textContent='';el.className='muted'},3500)}
function setBtnLoading(btn,loading,label){if(!btn)return;if(loading){btn.disabled=true;btn.textContent='Enviando‚Ä¶'}else{btn.disabled=false;btn.textContent=label||btn.dataset.label||'Enviar'}}

/* ===== STORE ===== */
const store={get(k,d){try{const v=localStorage.getItem(k);return v?JSON.parse(v):d}catch{return d}},
             set(k,v){try{localStorage.setItem(k,JSON.stringify(v));return true}catch{return false}},
             del(k){try{localStorage.removeItem(k)}catch{}}};

/* ===== DATA BASE ===== */
const DEFAULTS={
  choferes:["Freddy","Tatiana","Javier"],
  camiones:[{camion:"Cami√≥n 01",placa:"ABC-123"}],
  solicitantes:["Don Leandro","Don Francisco","Don Luis","Giovanni","Javier","Braulio","V√≠ctor","Viviana","Guillermo","Kevin","Freddy","Tatiana"],
  lotesRaw:[
    {finca:"Buena Vista",lote:"Lote 001"},{finca:"Buena Vista",lote:"Lote 002"},{finca:"Buena Vista",lote:"Lote 003"},{finca:"Buena Vista",lote:"Lote 005"},{finca:"Buena Vista",lote:"Lote 007"},{finca:"Buena Vista",lote:"Lote 008"},{finca:"Buena Vista",lote:"Lote 009"},{finca:"Buena Vista",lote:"Lote 011"},{finca:"Buena Vista",lote:"Lote 014"},{finca:"Buena Vista",lote:"Lote 015"},{finca:"Buena Vista",lote:"Lote 016"},
    {finca:"Ca√±o Blanco",lote:"Lote 001"},{finca:"Ca√±o Blanco",lote:"Lote 002"},{finca:"Ca√±o Blanco",lote:"Lote 003"},{finca:"Ca√±o Blanco",lote:"Lote 004"},{finca:"Ca√±o Blanco",lote:"Lote 005"},{finca:"Ca√±o Blanco",lote:"Lote 006"},{finca:"Ca√±o Blanco",lote:"Lote 007"},{finca:"Ca√±o Blanco",lote:"Lote 008"},{finca:"Ca√±o Blanco",lote:"Lote 009"},{finca:"Ca√±o Blanco",lote:"Lote 011"},
    {finca:"Chorcha",lote:"Lote 001"},
    {finca:"Don Cuyo",lote:"Lote 001"},{finca:"Don Cuyo",lote:"Lote 002"},{finca:"Don Cuyo",lote:"Lote 003"},{finca:"Don Cuyo",lote:"Lote 004"},
    {finca:"Enrique",lote:"Lote 001"},{finca:"Enrique",lote:"Lote 002"},
    {finca:"Guayabito",lote:"Lote 001"},{finca:"Guayabito",lote:"Lote 002"},{finca:"Guayabito",lote:"Lote 003"},{finca:"Guayabito",lote:"Lote 004
