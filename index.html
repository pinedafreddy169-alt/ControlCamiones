<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Camiones BYC — Viajes + Tiempos Muertos</title>
  <style>
    :root{
      --bg:#0f1115;--panel:#151923;--muted:#8a90a2;--text:#e8ecf1;
      --accent:#5ea1ff;--danger:#ff5e7a;--ok:#2bd27f;--border:#232838;
    }
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{max-width:1100px;margin:0 auto;padding:20px}
    h1{margin:0 0 6px;font-size:1.9rem}
    .lead{margin:0 0 16px;color:var(--muted)}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 16px}
    .tab{padding:10px 14px;border:1px solid var(--border);border-radius:10px;background:#101626;color:var(--muted);cursor:pointer}
    .tab.active{background:var(--accent);color:#081321;border-color:transparent;font-weight:700}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:16px;margin-bottom:16px}
    label{font-size:.9rem;color:var(--muted)}
    input,select,textarea,button{width:100%;padding:10px;border-radius:10px;border:1px solid var(--border);background:#101626;color:var(--text)}
    textarea{min-height:90px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    .row{margin-bottom:12px}
    .actions{display:flex;gap:10px;flex-wrap:wrap}
    .btn{background:#1b2233} .primary{background:var(--accent);color:#061228;font-weight:700}
    .ok{color:var(--ok);font-weight:700} .error{color:var(--danger);font-weight:700} .muted{color:var(--muted)}
    table{width:100%;border-collapse:collapse;margin-top:10px} th,td{border:1px solid var(--border);padding:8px;font-size:.95rem} th{background:#101626;color:var(--muted);text-align:left}
    @media(max-width:900px){.grid2,.grid3{grid-template-columns:1fr}}
  </style>
</head>
<body>
<div class="wrap">
  <h1>Camiones BYC</h1>
  <p class="lead">Viajes, Tiempos Muertos y sincronización con Google Sheets.</p>

  <div class="tabs">
    <button class="tab active" data-tab="viaje">Registrar viaje</button>
    <button class="tab" data-tab="tm">Tiempos muertos</button>
  </div>

  <!-- VIAJE -->
  <section id="viaje" class="card">
    <div class="grid3 row">
      <div><label>Fecha</label><input type="date" id="v_fecha"></div>
      <div><label>Chofer</label><input id="v_chofer" placeholder="Nombre del chofer"></div>
      <div><label>Camión</label><input id="v_camion" placeholder="Unidad"></div>
    </div>
    <div class="grid2 row">
      <div><label>Placa</label><input id="v_placa" placeholder="Placa"></div>
      <div><label>Operador</label><input id="v_user" placeholder="Tu nombre (opcional)"></div>
    </div>

    <div class="row"><strong>Origen</strong></div>
    <div class="grid2 row">
      <div><label>Finca (origen)</label><select id="o_finca"></select></div>
      <div><label>Lote (origen)</label><select id="o_lote"></select></div>
    </div>

    <div class="row"><strong>Destino</strong></div>
    <div class="grid2 row">
      <div><label>Finca (destino)</label><select id="d_finca"></select></div>
      <div><label>Lote (destino)</label><select id="d_lote"></select></div>
    </div>

    <div class="grid2 row">
      <div><label>Hora salida</label><input type="time" id="v_salida"></div>
      <div><label>Hora llegada</label><input type="time" id="v_llegada"></div>
    </div>

    <div class="row"><label>Observaciones</label><textarea id="v_obs" placeholder="Notas del viaje"></textarea></div>

    <div class="actions">
      <button class="primary" id="btnEnviar" data-label="Enviar a Excel">Enviar a Excel</button>
      <button class="btn" id="btnLimpiar">Limpiar</button>
      <span id="estadoEnvio" class="muted"></span>
    </div>
  </section>

  <!-- TM -->
  <section id="tm" class="card" hidden>
    <div class="grid3 row">
      <div><label>Fecha</label><input type="date" id="tm_fecha"></div>
      <div><label>Chofer</label><input id="tm_chofer" placeholder="Nombre del chofer"></div>
      <div><label>Camión</label><input id="tm_camion" placeholder="Unidad"></div>
    </div>
    <div class="grid2 row">
      <div><label>Hora inicio</label><input type="time" id="tm_inicio"></div>
      <div><label>Hora fin</label><input type="time" id="tm_fin"></div>
    </div>
    <div class="grid2 row">
      <div>
        <label>Motivo / Labor</label>
        <select id="tm_labor">
          <option>Esperando personal</option>
          <option>Mantenimiento del vehículo</option>
          <option>Lavado del vehículo</option>
          <option>Carga de materiales</option>
          <option>Descarga de materiales</option>
          <option>Documentación / Papeleo</option>
          <option>Otro</option>
        </select>
      </div>
      <div><label>Observaciones</label><input id="tm_obs" placeholder="Detalle (opcional)"></div>
    </div>
    <div class="actions">
      <button class="primary" id="tm_btnEnviar" data-label="Enviar TM a Excel">Enviar TM a Excel</button>
      <span id="tm_estadoEnvio" class="muted"></span>
    </div>
  </section>
</div>

<script>
/* ================= CONFIG ================= */
const GAS_URL = "https://script.google.com/macros/s/AKfycbyQOsvg9RiNDfCA3WNQiWZLmeVThFCKQfnWq9bkSx5uVxRKF3xFKznsx7qulC8ksYeHsA/exec";

/* ====== DATOS: FINCAS & LOTES (desde tu lista) ====== */
const LOTES_RAW = [
  // Buena Vista
  ["Buena Vista","Lote 001"],["Buena Vista","Lote 002"],["Buena Vista","Lote 003"],
  ["Buena Vista","Lote 005"],["Buena Vista","Lote 007"],["Buena Vista","Lote 008"],
  ["Buena Vista","Lote 009"],["Buena Vista","Lote 011"],["Buena Vista","Lote 014"],
  ["Buena Vista","Lote 015"],["Buena Vista","Lote 016"],
  // Caño Blanco
  ["Caño Blanco","Lote 001"],["Caño Blanco","Lote 002"],["Caño Blanco","Lote 003"],
  ["Caño Blanco","Lote 004"],["Caño Blanco","Lote 005"],["Caño Blanco","Lote 006"],
  ["Caño Blanco","Lote 007"],["Caño Blanco","Lote 008"],["Caño Blanco","Lote 009"],
  ["Caño Blanco","Lote 011"],
  // Chorcha
  ["Chorcha","Lote 001"],
  // Don Cuyo
  ["Don Cuyo","Lote 001"],["Don Cuyo","Lote 002"],["Don Cuyo","Lote 003"],["Don Cuyo","Lote 004"],
  // Enrique
  ["Enrique","Lote 001"],["Enrique","Lote 002"],
  // Guayabito
  ["Guayabito","Lote 001"],["Guayabito","Lote 002"],["Guayabito","Lote 003"],["Guayabito","Lote 004"],
  ["Guayabito","Lote 005"],["Guayabito","Lote 006"],["Guayabito","Lote 011"],["Guayabito","Lote 012"],
  ["Guayabito","Lote 014"],["Guayabito","Lote 015"],["Guayabito","Lote 017"],["Guayabito","Lote 019"],
  ["Guayabito","Lote 021"],["Guayabito","Lote 022"],["Guayabito","Lote 027"],
  // Los Abuelos / Los Angeles
  ["Los Abuelos","Lote 001"],["Los Angeles","Lote 001"],
  // Oscar
  ["Oscar","Lote 001"],["Oscar","Lote 002"],["Oscar","Lote 003"],
  // Pajarilla
  ["Pajarilla","Lote 001"],
  // Pataste
  ["Pataste","Lote 001"],["Pataste","Lote 002"],["Pataste","Lote 003"],["Pataste","Lote 004"],
  ["Pataste","Lote 006"],["Pataste","Lote 007"],["Pataste","Lote 008"],
  // Progreso
  ["Progreso","Lote 001"],["Progreso","Lote 002"],["Progreso","Lote 003"],["Progreso","Lote 004"],["Progreso","Lote 005"],
  // Rescate
  ["Rescate","Lote 001"],["Rescate","Lote 004"],["Rescate","Lote 005"],["Rescate","Lote 006"],
  ["Rescate","Lote 007"],["Rescate","Lote 008"],["Rescate","Lote 013"],
  // San Luis, Tuto
  ["San Luis","Lote 001"],["Tuto","Lote 001"]
];

/* ====== Utilidades de datos (dedupe + orden) ====== */
function dedup(arr){
  const m = new Map();
  arr.forEach(([f,l])=>{
    const k = f.trim()+"|"+l.trim();
    if(!m.has(k)) m.set(k,{finca:f.trim(), lote:l.trim()});
  });
  return Array.from(m.values());
}
const LOTES = dedup(LOTES_RAW);
const FINCAS = [...new Set(LOTES.map(x=>x.finca))].sort();

/* ====== UI helpers ====== */
const $ = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);
function setBtnLoading(btn,loading,label){
  if(!btn) return;
  if(loading){ btn.disabled = true; btn.textContent = "Enviando…"; }
  else { btn.disabled = false; btn.textContent = label || btn.dataset.label || "Enviar"; }
}
function toast(el,msg,ok=true){
  if(!el) return;
  el.textContent = msg;
  el.className = ok ? "ok" : "error";
  setTimeout(()=>{el.textContent="";el.className="muted"},4000);
}

/* ====== Fincas & Lotes selectors ====== */
function fillFincas(sel, def){
  const el = $(sel);
  el.innerHTML = FINCAS.map(f=>`<option value="${f}">${f}</option>`).join("");
  el.value = FINCAS.includes(def) ? def : FINCAS[0];
}
function fillLotes(fincaSel, loteSel, defLote){
  const f = $(fincaSel).value;
  const elL = $(loteSel);
  const arr = LOTES.filter(x=>x.finca===f);
  elL.innerHTML = arr.map(x=>`<option value="${x.lote}">${x.lote}</option>`).join("");
  elL.value = arr.some(x=>x.lote===defLote) ? defLote : (arr[0]?.lote || "");
}
function initOrigenDestino(){
  // Por defecto: Caño Blanco
  fillFincas("#o_finca","Caño Blanco"); fillLotes("#o_finca","#o_lote");
  fillFincas("#d_finca","Caño Blanco"); fillLotes("#d_finca","#d_lote");
  $("#o_finca").addEventListener("change",()=>fillLotes("#o_finca","#o_lote"));
  $("#d_finca").addEventListener("change",()=>fillLotes("#d_finca","#d_lote"));
}

/* ====== Tabs ====== */
$$(".tab").forEach(b=>b.onclick=()=>{
  $$(".tab").forEach(x=>x.classList.remove("active"));
  b.classList.add("active");
  ["viaje","tm"].forEach(id=>$("#"+id).hidden=(id!==b.dataset.tab));
});

/* ====== Inicial ====== */
(function init(){
  const hoy = new Date(); const iso = hoy.toISOString().slice(0,10);
  $("#v_fecha").value = iso; $("#tm_fecha").value = iso;
  initOrigenDestino();
})();

/* ====== LECTURA DE FORMULARIOS ====== */
function leerViaje(){
  const origen = `${$("#o_finca").value} / ${$("#o_lote").value}`;
  const destino = `${$("#d_finca").value} / ${$("#d_lote").value}`;
  return {
    fecha: $("#v_fecha").value,
    camion: $("#v_camion").value,
    placa: $("#v_placa").value,
    chofer: $("#v_chofer").value,
    operador: $("#v_user").value,
    origen, destino,
    salida: $("#v_salida").value,
    llegada: $("#v_llegada").value,
    observaciones: $("#v_obs").value,
    _ts: Date.now()
  };
}
function leerTM(){
  return {
    _form: "tiempos_muertos",
    fecha: $("#tm_fecha").value,
    chofer: $("#tm_chofer").value,
    camion: $("#tm_camion").value,
    inicio: $("#tm_inicio").value,
    fin: $("#tm_fin").value,
    labor: $("#tm_labor").value,
    observaciones: $("#tm_obs").value,
    _ts: Date.now()
  };
}

/* ====== Envío a GAS ====== */
async function enviarRegistro(reg, estadoEl, botonEl){
  try{
    setBtnLoading(botonEl,true);
    const res = await fetch(GAS_URL, {
      method: "POST",
      headers: {"Content-Type":"application/x-www-form-urlencoded"},
      body: new URLSearchParams({ payload: JSON.stringify([reg]) })
    });
    const txt = await res.text();
    let j; try{ j = JSON.parse(txt) }catch{ j = {ok:true} }
    if(!res.ok || !j.ok){
      const msg = !res.ok ? `HTTP ${res.status} ${res.statusText} — ${txt.slice(0,200)}` : (j.error||"Respuesta no OK");
      toast(estadoEl, "Error: " + msg, false);
      return false;
    }
    toast(estadoEl, "Enviado ✅", true);
    return true;
  }catch(err){
    toast(estadoEl, String(err), false);
    return false;
  }finally{
    setBtnLoading(botonEl,false,botonEl?.dataset.label);
  }
}

/* ====== Acciones ====== */
$("#btnEnviar").addEventListener("click", async ()=>{
  await enviarRegistro(leerViaje(), $("#estadoEnvio"), $("#btnEnviar"));
});
$("#btnLimpiar").addEventListener("click", ()=>{
  $$("#viaje input,#viaje textarea").forEach(e=>{
    if(e.id!=="v_fecha") e.value="";
  });
  initOrigenDestino();
});
$("#tm_btnEnviar").addEventListener("click", async ()=>{
  await enviarRegistro(leerTM(), $("#tm_estadoEnvio"), $("#tm_btnEnviar"));
});
</script>
</body>
</html>
