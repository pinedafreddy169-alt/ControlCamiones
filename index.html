<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Control de Camiones — BYC</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#0f1115; --card:#171a21; --txt:#e7ecf2; --muted:#9aa4b2; --pri:#ef4444; --pri2:#b91c1c; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, Arial, sans-serif; background:var(--bg); color:var(--txt); }
    header { padding:16px 20px; border-bottom:1px solid #222833; display:flex; align-items:center; gap:12px; }
    header h1 { font-size:20px; margin:0; color:#ff6b6b; }
    nav { display:flex; gap:8px; padding:10px 20px; border-bottom:1px solid #222833; flex-wrap:wrap; }
    .tab { padding:8px 12px; border-radius:10px; background:#1d232f; color:var(--muted); cursor:pointer; border:1px solid #242b38; }
    .tab.active { color:#fff; background:#2a3242; border-color:#2f394d; }
    main { padding:16px 20px; max-width:1000px; margin:0 auto; }
    .card { background:var(--card); border:1px solid #222833; border-radius:16px; padding:16px; }
    label { display:block; margin:10px 0 6px; font-weight:600; color:#cfd6df; }
    input, select, textarea { width:100%; background:#12161d; color:#e7ecf2; border:1px solid #2a3242; border-radius:10px; padding:10px 12px; font-size:16px; }
    textarea { min-height:90px; resize:vertical; }
    .grid { display:grid; gap:12px; }
    @media (min-width:720px){ .grid.cols-2 { grid-template-columns:1fr 1fr; } .grid.cols-3 { grid-template-columns: repeat(3,1fr);} }
    .actions { display:flex; flex-wrap:wrap; gap:10px; margin-top:14px; }
    button { border:0; border-radius:12px; padding:12px 16px; font-weight:700; cursor:pointer; }
    .btn { background:#293246; color:#e7ecf2; }
    .btn-primary { background:var(--pri); color:#fff; }
    .btn-primary:active { background:var(--pri2); }
    .muted { color:var(--muted); }
    .list { margin-top:12px; }
    .row { padding:10px; border:1px solid #222833; border-radius:12px; background:#12161d; margin-bottom:8px; font-size:14px; }
    .right { text-align:right; }
  </style>
</head>
<body>
  <header>
    <span style="font-size:22px">🚛</span>
    <h1>Control de Camiones — BYC</h1>
  </header>

  <nav>
    <div class="tab active" data-tab="registro">Registro</div>
    <div class="tab" data-tab="registros">Registros</div>
    <div class="tab" data-tab="catalogos">Choferes & Camiones</div>
    <div class="muted" id="localCount" style="margin-left:auto">Registros locales: 0</div>
  </nav>

  <main>
    <!-- TAB REGISTRO -->
    <section id="tab-registro" class="card">
      <div class="grid cols-3">
        <div>
          <label>Fecha</label>
          <input type="date" id="fecha"/>
        </div>
        <div>
          <label>Camión</label>
          <select id="camion"></select>
        </div>
        <div>
          <label>Placa</label>
          <input type="text" id="placa" placeholder="ABC-123"/>
        </div>
      </div>

      <div class="grid cols-3">
        <div>
          <label>Chofer</label>
          <select id="chofer"></select>
        </div>
        <div>
          <label>Origen — Finca/Lote</label>
          <input type="text" id="origen" placeholder="Finca/Lote"/>
        </div>
        <div>
          <label>Destino — Finca/Lote</label>
          <input type="text" id="destino" placeholder="Finca/Lote"/>
        </div>
      </div>

      <div class="grid cols-2">
        <div>
          <label>Salida</label>
          <input type="time" id="salida"/>
        </div>
        <div>
          <label>Llegada</label>
          <input type="time" id="llegada"/>
        </div>
      </div>

      <div>
        <label>Observaciones</label>
        <textarea id="observaciones" placeholder="Notas u observaciones..."></textarea>
      </div>

      <div class="actions">
        <button class="btn" type="button" id="btnGuardar">Guardar</button>
        <button class="btn" type="button" id="btnPDF">Descargar PDF</button>
        <button class="btn-primary" type="button" id="btnSync">Sincronizar</button>
        <div class="muted right" style="flex:1 1 auto"></div>
      </div>
    </section>

    <!-- TAB REGISTROS -->
    <section id="tab-registros" class="card" style="display:none">
      <div class="actions">
        <button class="btn" type="button" id="btnBorrarLocal">Borrar locales</button>
        <button class="btn" type="button" id="btnExportJSON">Exportar JSON</button>
      </div>
      <div class="list" id="listaRegistros"></div>
    </section>

    <!-- TAB CATALOGOS -->
    <section id="tab-catalogos" class="card" style="display:none">
      <div class="grid cols-2">
        <div>
          <label>Camiones (uno por línea)</label>
          <textarea id="catCamiones">Camión 01
Camión 02
Camión 03</textarea>
        </div>
        <div>
          <label>Choferes (uno por línea)</label>
          <textarea id="catChoferes">Braulio
Víctor
Roberto</textarea>
        </div>
      </div>
      <div class="actions">
        <button class="btn" type="button" id="btnAplicarCatalogos">Aplicar catálogos</button>
      </div>
    </section>
  </main>

  <!-- jsPDF para PDF simple -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
  /********** CONFIG **********/
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx-N1v3hc4Gumo3ZH_vBQ_mm_03i8n-llBJ31urziJgLV6-Qc8kBEy5m5AjOsccBTRGtw/exec";
  const STORAGE_KEY = "camiones_registros"; // ¡que sea el mismo en todo el proyecto!

  /********** STATE **********/
  const $ = (sel) => document.querySelector(sel);

  // Navegación de tabs
  document.querySelectorAll('.tab').forEach(t => {
    t.addEventListener('click', () => {
      document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
      t.classList.add('active');
      const tab = t.dataset.tab;
      ['registro','registros','catalogos'].forEach(name => {
        $('#tab-' + name).style.display = (name === tab) ? '' : 'none';
      });
    });
  });

  // Catálogos -> selects
  function aplicarCatalogos() {
    const camiones = $('#catCamiones').value.split(/\n+/).map(s => s.trim()).filter(Boolean);
    const choferes = $('#catChoferes').value.split(/\n+/).map(s => s.trim()).filter(Boolean);
    const camionSel = $('#camion'); const choferSel = $('#chofer');
    camionSel.innerHTML = camiones.map(c => `<option>${c}</option>`).join('');
    choferSel.innerHTML = choferes.map(c => `<option>${c}</option>`).join('');
  }
  $('#btnAplicarCatalogos').addEventListener('click', aplicarCatalogos);
  aplicarCatalogos();

  // LocalStorage helpers
  const readLocal = () => JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
  const writeLocal = (arr) => localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
  const clearLocal = () => localStorage.removeItem(STORAGE_KEY);

  function refreshLocalCount() {
    const n = readLocal().length;
    $('#localCount').textContent = `Registros locales: ${n}`;
  }

  function renderLista() {
    const arr = readLocal();
    const cont = $('#listaRegistros');
    cont.innerHTML = arr.length ? arr.map((r,i) =>
      `<div class="row">(${i+1}) ${r.fecha || ''} — ${r.camion || ''} — ${r.chofer || ''} — ${r.origen || ''} → ${r.destino || ''}</div>`
    ).join('') : '<div class="muted">Sin registros locales…</div>';
  }

  // Captura del formulario
  function getFormData() {
    return {
      fecha: $('#fecha').value,
      camion: $('#camion').value,
      placa: $('#placa').value,
      chofer: $('#chofer').value,
      origen: $('#origen').value,
      destino: $('#destino').value,
      salida: $('#salida').value,
      llegada: $('#llegada').value,
      observaciones: $('#observaciones').value
    };
  }

  // Guardar
  $('#btnGuardar').addEventListener('click', () => {
    const r = getFormData();
    if (!r.fecha || !r.camion || !r.chofer) { alert('⚠️ Fecha, Camión y Chofer son obligatorios'); return; }
    const arr = readLocal(); arr.push(r); writeLocal(arr);
    refreshLocalCount(); renderLista();
    alert('✅ Registro guardado localmente');
  });

  // Exportar PDF simple
  $('#btnPDF').addEventListener('click', () => {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const r = getFormData();
    let y = 12;
    doc.setFontSize(14); doc.text('Registro de Camión — BYC', 10, y); y += 8;
    doc.setFontSize(11);
    Object.entries(r).forEach(([k,v]) => { doc.text(`${k.toUpperCase()}: ${v||''}`, 10, y); y += 7; });
    doc.save('registro_camion.pdf');
  });

  // Sincronizar
  $('#btnSync').addEventListener('click', async () => {
    const registros = readLocal();
    if (!registros.length) { alert('No hay registros locales.'); return; }

    const params = new URLSearchParams();
    params.append('payload', JSON.stringify(registros));

    try {
      const resp = await fetch(SCRIPT_URL, { method:'POST', body: params });
      if (resp.ok) {
        clearLocal(); refreshLocalCount(); renderLista();
        alert('🚀 Sincronización completada');
      } else {
        alert('❌ Falló la sincronización (HTTP ' + resp.status + ')');
      }
    } catch (e) {
      alert('⚠️ Falló la sincronización: ' + (e?.message || e));
    }
  });

  // Tab Registros: utilidades
  $('#btnBorrarLocal')?.addEventListener('click', () => {
    if (confirm('¿Borrar todos los registros locales?')) {
      clearLocal(); refreshLocalCount(); renderLista();
    }
  });
  $('#btnExportJSON')?.addEventListener('click', () => {
    const blob = new Blob([JSON.stringify(readLocal(), null, 2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'camiones_local.json'; a.click();
    URL.revokeObjectURL(url);
  });

  // Inicial
  refreshLocalCount(); renderLista();
  </script>
</body>
</html>
