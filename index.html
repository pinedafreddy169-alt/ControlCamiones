<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<title>Control Camiones — MIN</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  :root{--bg:#0f1115;--card:#171a21;--txt:#e7ecf2;--muted:#9aa4b2;--pri:#ef4444;}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--txt);font-family:system-ui,Arial,sans-serif}
  .wrap{max-width:860px;margin:0 auto;padding:18px}
  h1{margin:0 0 12px;color:#ff6b6b}
  label{display:block;margin:10px 0 6px;font-weight:600;color:#cfd6df}
  input,textarea,select{width:100%;padding:10px;border-radius:10px;border:1px solid #2a3242;background:#12161d;color:#e7ecf2}
  textarea{min-height:80px}
  .grid{display:grid;gap:10px}
  @media(min-width:700px){.cols-3{grid-template-columns:repeat(3,1fr)} .cols-2{grid-template-columns:repeat(2,1fr)}}
  .card{background:var(--card);border:1px solid #222833;border-radius:14px;padding:14px;margin-top:12px}
  .row{background:#12161d;border:1px solid #222833;border-radius:10px;padding:8px;margin:6px 0;font-size:14px}
  .actions{display:flex;flex-wrap:wrap;gap:10px;margin-top:12px}
  button{border:0;border-radius:12px;padding:12px 16px;font-weight:700;cursor:pointer;background:#293246;color:#e7ecf2}
  .primary{background:var(--pri);color:#fff}
  .small{padding:8px 12px}
  .muted{color:var(--muted)}
</style>
</head>
<body>
<div class="wrap">
  <h1>🚛 Control Camiones — Modo mínimo</h1>

  <div class="card">
    <div class="grid cols-3">
      <div><label>Fecha</label><input type="date" id="fecha"></div>
      <div><label>Camión</label><input id="camion" placeholder="Camión 01"></div>
      <div><label>Placa</label><input id="placa" placeholder="ABC-123"></div>
    </div>
    <div class="grid cols-3">
      <div><label>Chofer</label><input id="chofer" placeholder="Nombre"></div>
      <div><label>Origen</label><input id="origen" placeholder="Finca/Lote"></div>
      <div><label>Destino</label><input id="destino" placeholder="Finca/Lote"></div>
    </div>
    <div class="grid cols-2">
      <div><label>Salida</label><input type="time" id="salida"></div>
      <div><label>Llegada</label><input type="time" id="llegada"></div>
    </div>
    <label>Observaciones</label><textarea id="obs"></textarea>

    <div class="actions">
      <button id="btnGuardar">💾 Guardar local</button>
      <button id="btnPing" class="small">🧪 Probar conexión</button>
      <button id="btnSync" class="primary">🔄 Sincronizar</button>
      <div style="margin-left:auto" class="muted" id="count">Registros locales: 0</div>
    </div>
  </div>

  <div class="card">
    <div class="actions">
      <button id="btnBorrar" class="small">Borrar locales</button>
      <button id="btnExport" class="small">Exportar JSON</button>
    </div>
    <div id="lista" class="muted">Sin registros…</div>
  </div>
</div>

<script>
/*** CONFIG FIJA (sin panel de config) ***/
const ENDPOINT = "https://script.google.com/macros/s/AKfycbx-N1v3hc4Gumo3ZH_vBQ_mm_03i8n-llBJ31urziJgLV6-Qc8kBEy5m5AjOsccBTRGtw/exec";
const KEY = "camiones_registros";

/*** helpers local ***/
const $ = sel => document.querySelector(sel);
const read = () => JSON.parse(localStorage.getItem(KEY) || "[]");
const write = a => localStorage.setItem(KEY, JSON.stringify(a));
const clearLocal = () => localStorage.removeItem(KEY);

function count() { $("#count").textContent = "Registros locales: " + read().length; }
function render() {
  const arr = read();
  $("#lista").innerHTML = arr.length ? arr.map((r,i)=>
    `<div class="row">(${i+1}) ${r.fecha||""} — ${r.camion||""} — ${r.chofer||""} — ${r.origen||""} → ${r.destino||""}</div>`
  ).join("") : "Sin registros…";
}

/*** UI ***/
function getForm() {
  return {
    fecha: $("#fecha").value,
    camion: $("#camion").value,
    placa: $("#placa").value,
    chofer: $("#chofer").value,
    origen: $("#origen").value,
    destino: $("#destino").value,
    salida: $("#salida").value,
    llegada: $("#llegada").value,
    observaciones: $("#obs").value
  };
}

$("#btnGuardar").addEventListener("click", ()=>{
  const r = getForm();
  if (!r.fecha || !r.camion || !r.chofer) { alert("⚠️ Fecha, Camión y Chofer son obligatorios"); return; }
  const arr = read(); arr.push(r); write(arr); count(); render();
  alert("✅ Guardado local.");
});

$("#btnPing").addEventListener("click", async ()=>{
  try {
    const resp = await fetch(ENDPOINT + "?ping=1", { method:"GET" });
    const txt = await resp.text();
    alert("PING: HTTP " + resp.status + " — " + txt.slice(0,60));
  } catch(e) { alert("PING fallo: " + (e.message||e)); }
});

$("#btnSync").addEventListener("click", async ()=>{
  const registros = read();
  if (!registros.length) { alert("No hay registros."); return; }
  const params = new URLSearchParams();
  params.append("payload", JSON.stringify(registros));
  try {
    const resp = await fetch(ENDPOINT, { method:"POST", body:params });
    const ok = resp.ok;
    let body = ""; try { body = await resp.text(); } catch {}
    if (ok) { clearLocal(); count(); render(); alert("🚀 Sincronizado. " + (body || "")); }
    else { alert("❌ HTTP " + resp.status + " " + body); }
  } catch(e) { alert("⚠️ Falló fetch: " + (e.message||e)); }
});

$("#btnBorrar").addEventListener("click", ()=>{
  if (confirm("¿Borrar locales?")) { clearLocal(); count(); render(); }
});

$("#btnExport").addEventListener("click", ()=>{
  const blob = new Blob([JSON.stringify(read(),null,2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a"); a.href = url; a.download = "camiones_local.json"; a.click();
  URL.revokeObjectURL(url);
});

count(); render();
</script>
</body>
</html>
